<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SOCC Route Finder — Swavesey & Over Cycling Club</title>

  <!-- Google Fonts — Inter for clean modern typography -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />

  <style>
    /* ─── DESIGN TOKENS ─────────────────────────────────────────── */
    :root {
      /* SOCC Brand Palette */
      --dark:       #1B2631;
      --dark-light: #243447;
      --dark-deep:  #111B24;
      --teal:       #2CBCB3;
      --teal-light: #45D4CB;
      --teal-dark:  #1A9E96;
      --teal-dim:   rgba(44,188,179,0.10);
      --teal-glow:  rgba(44,188,179,0.25);

      /* Legacy aliases (so existing JS references still work) */
      --navy:       var(--dark);
      --navy-light: var(--dark-light);
      --navy-dark:  var(--dark-deep);
      --orange:     var(--teal);
      --orange-light: var(--teal-light);
      --orange-dim: var(--teal-dim);

      /* Neutrals */
      --white:      #ffffff;
      --grey-50:    #f7f9fa;
      --grey-100:   #eef1f5;
      --grey-200:   #dce1e9;
      --grey-400:   #8c97a8;
      --grey-600:   #4e5d6e;
      --grey-800:   #2a3440;

      /* Semantic */
      --green:      #10b981;
      --amber:      #f59e0b;
      --red:        #ef4444;
      --blue:       #3b82f6;
      --purple:     #8b5cf6;

      /* Surfaces */
      --surface:    #ffffff;
      --surface-elevated: #f8fffe;

      /* Typography */
      --font-main:  'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      --font-mono:  'SF Mono', 'Cascadia Code', 'Consolas', 'Fira Code', monospace;

      /* Layout */
      --radius:     12px;
      --radius-sm:  8px;
      --radius-xs:  4px;
      --shadow-sm:  0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
      --shadow:     0 4px 12px rgba(0,0,0,.08), 0 2px 4px rgba(0,0,0,.04);
      --shadow-lg:  0 10px 30px rgba(0,0,0,.12), 0 4px 8px rgba(0,0,0,.06);
      --shadow-teal: 0 4px 16px rgba(44,188,179,0.20);
      --transition: 0.2s ease;
      --transition-slow: 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ─── RESET ─────────────────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 16px; scroll-behavior: smooth; -webkit-text-size-adjust: 100%; }
    body {
      font-family: var(--font-main);
      background: var(--grey-50);
      color: var(--grey-800);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      line-height: 1.5;
    }
    a { color: inherit; text-decoration: none; }
    button { cursor: pointer; font-family: inherit; border: none; background: none; }
    img { display: block; max-width: 100%; }

    /* ─── HEADER ─────────────────────────────────────────────────── */
    .site-header {
      background: var(--dark-deep);
      padding: 0 1.5rem;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 2px solid var(--teal);
      backdrop-filter: blur(10px);
    }
    .site-header .brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .site-header .logo-icon {
      width: 38px;
      height: 38px;
      background: linear-gradient(135deg, var(--teal) 0%, var(--teal-dark) 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(44,188,179,0.3);
    }
    .site-header .logo-icon svg { width: 20px; height: 20px; fill: white; }
    .brand-name {
      font-size: 1.05rem;
      font-weight: 800;
      color: white;
      letter-spacing: 0.02em;
    }
    .brand-sub {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.5);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-weight: 500;
    }
    .header-tag {
      background: rgba(44,188,179,0.15);
      color: var(--teal-light);
      font-size: 0.68rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 0.3rem 0.75rem;
      border-radius: 20px;
      border: 1px solid rgba(44,188,179,0.3);
    }

    /* ─── HERO BANNER ────────────────────────────────────────────── */
    .hero {
      background: linear-gradient(135deg, var(--dark) 0%, var(--dark-light) 50%, #1a3a4a 100%);
      padding: 2.5rem 1.5rem 2rem;
      position: relative;
      overflow: hidden;
    }
    .hero::before {
      content: '';
      position: absolute;
      top: -60px; right: -80px;
      width: 320px; height: 320px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(44,188,179,0.12) 0%, transparent 70%);
      pointer-events: none;
    }
    .hero::after {
      content: '';
      position: absolute;
      bottom: -100px; left: 20%;
      width: 250px; height: 250px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(44,188,179,0.06) 0%, transparent 70%);
      pointer-events: none;
    }
    .hero-inner {
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }
    .hero h1 {
      font-size: clamp(1.5rem, 4vw, 2.4rem);
      color: white;
      font-weight: 900;
      line-height: 1.15;
      letter-spacing: -0.03em;
    }
    .hero h1 span { color: var(--teal-light); }
    .hero-sub {
      margin-top: 0.5rem;
      color: rgba(255,255,255,0.55);
      font-size: 0.9rem;
      font-weight: 400;
    }
    .hero-stats {
      margin-top: 1.5rem;
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
    }
    .hero-stat {
      display: flex;
      align-items: baseline;
      gap: 0.4rem;
    }
    .hero-stat .num {
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--teal);
      font-family: var(--font-mono);
      line-height: 1;
    }
    .hero-stat .label {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.5);
      letter-spacing: 0.05em;
      text-transform: uppercase;
      font-weight: 500;
    }

    /* ─── MAIN LAYOUT ────────────────────────────────────────────── */
    .app-body {
      flex: 1;
      max-width: 1280px;
      width: 100%;
      margin: 0 auto;
      padding: 1.5rem;
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 1.5rem;
      align-items: start;
    }

    /* ─── FILTER SIDEBAR ─────────────────────────────────────────── */
    .sidebar {
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--grey-200);
      position: sticky;
      top: 75px;
    }
    .sidebar-header {
      padding: 1rem 1.25rem 0.75rem;
      border-bottom: 1px solid var(--grey-100);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .sidebar-title {
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--grey-400);
    }
    .result-count {
      font-size: 0.72rem;
      background: var(--dark);
      color: white;
      padding: 0.2rem 0.65rem;
      border-radius: 20px;
      font-weight: 600;
    }
    .sidebar-body { padding: 1rem 1.25rem; }
    .filter-group { margin-bottom: 1.25rem; }
    .filter-label {
      font-size: 0.68rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--grey-600);
      margin-bottom: 0.5rem;
      display: block;
    }

    /* Range sliders */
    .range-group { display: flex; flex-direction: column; gap: 0.3rem; }
    .range-row { display: flex; align-items: center; gap: 0.5rem; }
    .range-val {
      font-size: 0.75rem;
      font-family: var(--font-mono);
      color: var(--dark);
      font-weight: 600;
      min-width: 48px;
      text-align: right;
    }
    input[type="range"] {
      flex: 1;
      -webkit-appearance: none;
      height: 4px;
      border-radius: 2px;
      background: var(--grey-200);
      outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--teal);
      cursor: pointer;
      border: 2.5px solid white;
      box-shadow: 0 1px 6px rgba(44,188,179,.35);
      transition: transform var(--transition), box-shadow var(--transition);
    }
    input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.15); box-shadow: 0 2px 8px rgba(44,188,179,.5); }

    /* Toggle buttons */
    .toggle-group { display: flex; gap: 0.4rem; flex-wrap: wrap; }
    .toggle-btn {
      padding: 0.3rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      border: 1.5px solid var(--grey-200);
      background: white;
      color: var(--grey-600);
      transition: all var(--transition);
    }
    .toggle-btn.active {
      background: var(--dark);
      border-color: var(--dark);
      color: white;
    }
    .toggle-btn:hover:not(.active) {
      border-color: var(--teal);
      color: var(--teal-dark);
      background: var(--teal-dim);
    }

    /* Checkbox grid */
    .checkbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.35rem; }
    .check-item {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      cursor: pointer;
      font-size: 0.78rem;
      color: var(--grey-600);
      font-weight: 500;
    }
    .check-item input[type="checkbox"] {
      width: 15px; height: 15px;
      accent-color: var(--teal);
      cursor: pointer;
    }

    /* Switch toggles */
    .switch-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    .switch-label { font-size: 0.8rem; color: var(--grey-600); font-weight: 500; }
    .switch {
      position: relative;
      width: 36px;
      height: 20px;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .switch-track {
      position: absolute;
      inset: 0;
      background: var(--grey-200);
      border-radius: 10px;
      transition: background var(--transition);
      cursor: pointer;
    }
    .switch-track::after {
      content: '';
      position: absolute;
      left: 2px; top: 2px;
      width: 16px; height: 16px;
      background: white;
      border-radius: 50%;
      transition: transform var(--transition);
      box-shadow: 0 1px 3px rgba(0,0,0,.2);
    }
    .switch input:checked + .switch-track { background: var(--teal); }
    .switch input:checked + .switch-track::after { transform: translateX(16px); }

    .reset-btn {
      width: 100%;
      padding: 0.6rem;
      border-radius: var(--radius-sm);
      background: var(--grey-100);
      color: var(--grey-600);
      font-size: 0.8rem;
      font-weight: 600;
      border: 1px solid var(--grey-200);
      transition: all var(--transition);
      margin-top: 0.25rem;
    }
    .reset-btn:hover { background: var(--dark); color: white; border-color: var(--dark); }

    /* Sort row */
    .sort-row {
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .sort-label { font-size: 0.75rem; color: var(--grey-400); font-weight: 600; white-space: nowrap; }
    .sort-select {
      flex: 1;
      border: 1.5px solid var(--grey-200);
      border-radius: var(--radius-sm);
      padding: 0.35rem 0.6rem;
      font-size: 0.78rem;
      font-family: inherit;
      color: var(--grey-800);
      background: white;
      outline: none;
    }
    .sort-select:focus { border-color: var(--teal); }

    /* ─── ROUTE CARDS ────────────────────────────────────────────── */
    .cards-area {}

    /* ─── VIEW TOGGLE TABS ───────────────────────────────────────── */
    .view-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      border-bottom: 2px solid var(--grey-200);
      padding-bottom: 0;
    }
    .view-tab {
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      padding: 0.55rem 1.1rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--grey-400);
      cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
      border-radius: 4px 4px 0 0;
    }
    .view-tab:hover  { color: var(--dark); }
    .view-tab.active { color: var(--teal); border-bottom-color: var(--teal); }

    /* ─── MASTER MAP ─────────────────────────────────────────────── */
    #masterMapPanel { display: none; }
    #masterMapPanel.active { display: block; }
    #masterMap {
      width: 100%;
      height: calc(100vh - 220px);
      min-height: 420px;
      border-radius: 10px;
      border: 1px solid var(--grey-200);
      box-shadow: var(--shadow-sm);
    }
    .map-route-popup { font-family: inherit; min-width: 200px; }
    .map-route-popup .pop-name {
      font-weight: 700; font-size: 0.95rem; color: var(--dark); margin-bottom: 0.4rem;
    }
    .map-route-popup .pop-stats {
      display: grid; grid-template-columns: 1fr 1fr; gap: 0.25rem 0.75rem;
      font-size: 0.8rem; color: var(--grey-600); margin-bottom: 0.6rem;
    }
    .map-route-popup .pop-btn {
      display: block; width: 100%; padding: 0.45rem;
      background: var(--teal); color: white; border: none; border-radius: var(--radius-sm);
      font-size: 0.8rem; font-weight: 600; cursor: pointer; text-align: center;
      transition: background var(--transition);
    }
    .map-route-popup .pop-btn:hover { background: var(--teal-dark); }
    .master-map-empty {
      display: flex; align-items: center; justify-content: center;
      height: 200px; color: var(--grey-400); font-size: 0.95rem;
      border: 2px dashed var(--grey-200); border-radius: 10px;
    }
    .cards-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .cards-toolbar .sort-row { margin-bottom: 0; }
    .routes-grid { display: flex; flex-direction: column; gap: 1rem; }

    .route-card {
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--grey-200);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      transition: box-shadow var(--transition-slow), transform var(--transition), border-color var(--transition);
      position: relative;
    }
    .route-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 4px; height: 100%;
      background: var(--teal);
      opacity: 0;
      transition: opacity var(--transition);
      border-radius: var(--radius) 0 0 var(--radius);
    }
    .route-card:hover {
      box-shadow: var(--shadow);
      transform: translateY(-2px);
      border-color: rgba(44,188,179,0.3);
    }
    .route-card:hover::before { opacity: 1; }
    .route-card:target, .route-card.highlighted {
      border-color: var(--teal);
      box-shadow: 0 0 0 3px var(--teal-dim), var(--shadow);
      animation: cardPulse 0.6s ease-out;
    }
    @keyframes cardPulse {
      0%   { box-shadow: 0 0 0 0 rgba(44,188,179,0.5); }
      50%  { box-shadow: 0 0 0 8px rgba(44,188,179,0.15); }
      100% { box-shadow: 0 0 0 3px var(--teal-dim), var(--shadow); }
    }
    /* Staggered card entry animation */
    @keyframes cardSlideIn {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .route-card { animation: cardSlideIn 0.35s ease-out both; }

    .card-main { padding: 1.1rem 1.25rem 1rem; }
    .card-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }
    .route-name {
      font-size: 1.1rem;
      font-weight: 800;
      color: var(--dark);
      letter-spacing: -0.01em;
      line-height: 1.2;
    }
    .route-source {
      font-size: 0.7rem;
      color: var(--grey-400);
      margin-top: 0.2rem;
    }

    .badges { display: flex; flex-wrap: wrap; gap: 0.35rem; }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
      padding: 0.22rem 0.6rem;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      white-space: nowrap;
    }
    /* Distance badge colours */
    .badge-dist-green  { background: #d4f4e8; color: #0e7d52; }
    .badge-dist-amber  { background: #fef3d7; color: #9b6b00; }
    .badge-dist-red    { background: #fde8e8; color: #9b1c1c; }
    .badge-ascent      { background: #e8edf7; color: #2a4a8a; }
    .badge-type-road   { background: #e8edf7; color: #1a3d7c; }
    .badge-type-gravel { background: #fef0e6; color: #8b3d0a; }
    .badge-busway      { background: #eaf4ff; color: #1a5ca8; }
    /* Direction badges */
    .badge-dir-N   { background: #e8f7f0; color: #0e6b4a; }
    .badge-dir-S   { background: #fef3d7; color: #9b6b00; }
    .badge-dir-E   { background: #edf3fe; color: #2747a0; }
    .badge-dir-W   { background: #dff0fa; color: #0e5c8a; }
    .badge-dir-NE  { background: #eafaf4; color: #0a7a5a; }
    .badge-dir-NW  { background: #e0f5f5; color: #0a6b6b; }
    .badge-dir-SE  { background: #fdf0e6; color: #8b4a00; }
    .badge-dir-SW  { background: #f0e8fd; color: #5a2a9b; }

    /* Weather indicator row on route cards */
    .card-weather-row {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      margin: 0.6rem 0 0.2rem;
      padding: 0.55rem 0.75rem;
      background: linear-gradient(135deg, var(--teal-dim), rgba(44,188,179,0.04));
      border-radius: var(--radius-sm);
      border: 1px solid rgba(44,188,179,0.12);
      font-size: 0.78rem;
      flex-wrap: wrap;
    }
    .card-weather-icon {
      font-size: 1rem;
      line-height: 1;
    }
    .card-weather-temp {
      font-weight: 700;
      color: var(--dark);
      font-size: 0.82rem;
    }
    .card-weather-wind {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      color: var(--grey-500);
      font-size: 0.75rem;
    }
    .card-weather-wind svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }
    .card-wind-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      font-size: 0.68rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      white-space: nowrap;
    }
    .card-wind-badge.pick-wind-tail { background: rgba(16,185,129,0.12); color: #059669; }
    .card-wind-badge.pick-wind-favour { background: rgba(245,158,11,0.12); color: #b45309; }
    .card-wind-badge.pick-wind-cross { background: rgba(251,146,60,0.12); color: #c2410c; }
    .card-wind-badge.pick-wind-head { background: rgba(239,68,68,0.12); color: #dc2626; }
    .card-match-score {
      margin-left: auto;
      font-weight: 800;
      font-size: 0.78rem;
      color: var(--teal-dark);
      white-space: nowrap;
    }
    .card-match-score .match-num {
      font-size: 0.92rem;
    }

    .card-meta {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 0.6rem;
      margin: 0.75rem 0;
      padding: 0.75rem;
      background: var(--grey-50);
      border-radius: var(--radius-sm);
    }
    .meta-item {}
    .meta-key {
      font-size: 0.65rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--grey-400);
      font-weight: 600;
    }
    .meta-val {
      font-size: 0.85rem;
      color: var(--dark);
      font-weight: 600;
      margin-top: 0.15rem;
    }
    .meta-val.mono { font-family: var(--font-mono); }

    .cafe-row {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.6rem 0.75rem;
      background: #fffbf5;
      border-radius: var(--radius-sm);
      border: 1px solid #f5e6cc;
      margin-bottom: 0.75rem;
    }
    .cafe-icon { font-size: 1rem; flex-shrink: 0; margin-top: 1px; }
    .cafe-name {
      font-weight: 700;
      font-size: 0.82rem;
      color: var(--grey-800);
    }
    .cafe-name a { color: var(--teal-dark); }
    .cafe-name a:hover { text-decoration: underline; }
    .cafe-hours { font-size: 0.75rem; color: var(--grey-400); margin-top: 0.15rem; }

    .last-ridden {
      font-size: 0.72rem;
      color: var(--grey-400);
      margin-bottom: 0.5rem;
    }
    .last-ridden span { font-weight: 600; color: var(--grey-600); }

    .warning-banner {
      display: flex;
      align-items: flex-start;
      gap: 0.4rem;
      background: #fff8e6;
      border: 1px solid #f5c842;
      border-radius: var(--radius-sm);
      padding: 0.5rem 0.75rem;
      font-size: 0.78rem;
      color: #7a5000;
      margin-bottom: 0.75rem;
      line-height: 1.4;
    }
    .warning-banner.has-roadwork { border-color: #f0a040; }
    .roadwork-badge {
      display: inline-block;
      background: #ff6600;
      color: white;
      font-size: 0.65rem;
      font-weight: 700;
      padding: 0.15rem 0.4rem;
      border-radius: 3px;
      margin-left: 0.4rem;
      letter-spacing: 0.04em;
    }

    .card-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      padding-top: 0.5rem;
      border-top: 1px solid var(--grey-100);
      margin-top: 0.75rem;
    }
    .action-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.4rem 0.9rem;
      border-radius: var(--radius-sm);
      font-size: 0.78rem;
      font-weight: 700;
      transition: all var(--transition);
      letter-spacing: 0.02em;
    }
    .btn-map {
      background: var(--dark);
      color: white;
    }
    .btn-map:hover { background: var(--dark-light); }
    .btn-map.active { background: var(--teal); }
    .btn-gpx {
      background: var(--green);
      color: white;
    }
    .btn-gpx:hover { opacity: 0.88; }
    .btn-gpx:disabled {
      background: var(--grey-200);
      color: var(--grey-400);
      cursor: not-allowed;
    }
    .btn-garmin {
      background: white;
      color: var(--dark);
      border: 1.5px solid var(--grey-200);
    }
    .btn-garmin:hover { border-color: var(--teal); background: var(--teal-dim); color: var(--teal-dark); }
    .btn-share {
      background: white;
      color: var(--grey-600);
      border: 1.5px solid var(--grey-200);
      margin-left: auto;
    }
    .btn-share:hover { border-color: var(--teal); color: var(--teal-dark); }

    /* Map panel */
    .map-panel {
      display: none;
      border-top: 3px solid var(--teal);
      background: var(--grey-50);
    }
    .map-panel.open { display: block; }

    .stats-bar {
      display: flex;
      gap: 0;
      overflow-x: auto;
      background: var(--dark);
      padding: 0;
    }
    .stats-bar-item {
      flex: 1;
      min-width: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0.7rem 0.5rem;
      border-right: 1px solid rgba(255,255,255,0.08);
    }
    .stats-bar-item:last-child { border-right: none; }
    .stats-bar-icon { font-size: 0.9rem; }
    .stats-bar-val {
      font-size: 0.9rem;
      font-weight: 800;
      color: var(--teal-light);
      font-family: var(--font-mono);
      line-height: 1.1;
    }
    .stats-bar-key {
      font-size: 0.6rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.45);
      margin-top: 0.15rem;
    }

    .map-container { height: 340px; }
    .map-container .leaflet-container { height: 100%; width: 100%; }
    .cafe-marker { background: none; border: none; }

    .elevation-wrap {
      padding: 0.75rem 1rem;
      background: white;
      border-top: 1px solid var(--grey-100);
    }
    .elevation-label {
      font-size: 0.65rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--grey-400);
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    .elevation-chart-wrap { height: 80px; }

    /* ─── EMPTY STATE ────────────────────────────────────────────── */
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--grey-400);
    }
    .empty-state .empty-icon { font-size: 3rem; margin-bottom: 1rem; }
    .empty-state h3 { color: var(--grey-600); font-size: 1.1rem; margin-bottom: 0.5rem; }
    .empty-state p { font-size: 0.875rem; margin-bottom: 1.25rem; }
    .empty-reset {
      display: inline-block;
      background: var(--teal);
      color: white;
      padding: 0.55rem 1.5rem;
      border-radius: var(--radius-sm);
      font-weight: 700;
      font-size: 0.85rem;
      cursor: pointer;
      border: none;
      font-family: inherit;
      transition: background var(--transition);
    }
    .empty-reset:hover { background: var(--teal-dark); }

    /* ─── LOADING STATE ──────────────────────────────────────────── */
    .loading-state {
      text-align: center;
      padding: 3rem;
      color: var(--grey-400);
    }
    .spinner {
      width: 36px; height: 36px;
      border: 3px solid var(--grey-200);
      border-top-color: var(--teal);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ─── WEATHER STRIP ───────────────────────────────────────────── */
    .weather-strip {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      padding: 1rem 1.5rem;
      background: var(--dark-deep);
      border-bottom: 1px solid rgba(44,188,179,0.15);
      scrollbar-width: thin;
      scrollbar-color: rgba(44,188,179,0.3) transparent;
    }
    .weather-strip::-webkit-scrollbar { height: 4px; }
    .weather-strip::-webkit-scrollbar-track { background: transparent; }
    .weather-strip::-webkit-scrollbar-thumb { background: rgba(44,188,179,0.3); border-radius: 2px; }

    .weather-day {
      flex: 0 0 auto;
      min-width: 100px;
      padding: 0.65rem 0.75rem;
      border-radius: var(--radius-sm);
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.06);
      text-align: center;
      transition: all var(--transition);
      cursor: default;
    }
    .weather-day:hover {
      background: rgba(44,188,179,0.08);
      border-color: rgba(44,188,179,0.2);
    }
    .weather-day.sunday-highlight {
      background: rgba(44,188,179,0.12);
      border-color: var(--teal);
      box-shadow: 0 0 12px rgba(44,188,179,0.15);
    }
    .weather-day-name {
      font-size: 0.68rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.5);
      margin-bottom: 0.3rem;
    }
    .weather-day.sunday-highlight .weather-day-name { color: var(--teal-light); }
    .weather-day-icon { font-size: 1.4rem; line-height: 1; margin-bottom: 0.25rem; }
    .weather-day-temp {
      font-size: 0.85rem;
      font-weight: 700;
      color: white;
      font-family: var(--font-mono);
    }
    .weather-day-temp span {
      font-size: 0.7rem;
      color: rgba(255,255,255,0.4);
      font-weight: 500;
    }
    .weather-day-wind {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.45);
      margin-top: 0.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.2rem;
    }
    .weather-day-wind .wind-arrow {
      display: inline-block;
      font-size: 0.75rem;
      transition: transform 0.3s ease;
    }
    .weather-day-rain {
      font-size: 0.6rem;
      color: rgba(255,255,255,0.35);
      margin-top: 0.15rem;
    }
    .weather-loading {
      color: rgba(255,255,255,0.35);
      font-size: 0.78rem;
      text-align: center;
      padding: 0.8rem;
      width: 100%;
    }

    /* ─── RIDE PLANNER ──────────────────────────────────────────── */
    .ride-planner {
      background: linear-gradient(160deg, var(--dark) 0%, #1a3040 50%, var(--dark-light) 100%);
      padding: 2rem 1.5rem;
      position: relative;
      overflow: hidden;
    }
    .ride-planner::before {
      content: '';
      position: absolute;
      top: -30%; right: -10%;
      width: 400px; height: 400px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(44,188,179,0.08) 0%, transparent 70%);
      pointer-events: none;
    }
    .ride-planner-inner {
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: 1fr 280px;
      gap: 2rem;
      align-items: start;
    }
    .planner-main { }
    .planner-title {
      font-size: 0.68rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--teal);
      margin-bottom: 0.3rem;
    }
    .planner-heading {
      font-size: clamp(1.3rem, 3vw, 1.8rem);
      font-weight: 900;
      color: white;
      letter-spacing: -0.02em;
      line-height: 1.2;
      margin-bottom: 0.4rem;
    }
    .planner-wind-advice {
      font-size: 0.88rem;
      color: rgba(255,255,255,0.6);
      line-height: 1.5;
      margin-bottom: 1.25rem;
    }
    .planner-wind-advice strong {
      color: var(--teal-light);
      font-weight: 600;
    }

    /* Target distance slider in planner */
    .planner-controls {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .planner-control-label {
      font-size: 0.72rem;
      font-weight: 600;
      color: rgba(255,255,255,0.5);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      white-space: nowrap;
    }
    .planner-slider {
      flex: 1;
      min-width: 120px;
      -webkit-appearance: none;
      height: 4px;
      border-radius: 2px;
      background: rgba(255,255,255,0.15);
      outline: none;
    }
    .planner-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px; height: 20px;
      border-radius: 50%;
      background: var(--teal);
      cursor: pointer;
      border: 3px solid white;
      box-shadow: 0 2px 8px rgba(0,0,0,.3);
    }
    .planner-slider-val {
      font-size: 1.1rem;
      font-weight: 800;
      color: var(--teal-light);
      font-family: var(--font-mono);
      min-width: 52px;
    }

    /* Weather card sidebar */
    .planner-weather-card {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(44,188,179,0.2);
      border-radius: var(--radius);
      padding: 1.25rem;
      text-align: center;
    }
    .planner-weather-day {
      font-size: 0.68rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--teal);
      margin-bottom: 0.15rem;
    }
    .planner-weather-date {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.5);
      margin-bottom: 0.75rem;
    }
    .planner-weather-icon {
      font-size: 2.5rem;
      line-height: 1;
      margin-bottom: 0.3rem;
    }
    .planner-weather-desc {
      font-size: 0.78rem;
      color: rgba(255,255,255,0.55);
      margin-bottom: 0.75rem;
    }
    .planner-weather-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.6rem;
      text-align: center;
    }
    .planner-weather-stat-val {
      font-size: 1.1rem;
      font-weight: 800;
      color: white;
      font-family: var(--font-mono);
      line-height: 1.2;
    }
    .planner-weather-stat-label {
      font-size: 0.6rem;
      color: rgba(255,255,255,0.4);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    /* Wind compass SVG */
    .wind-compass-wrap {
      margin: 0.75rem auto 0;
      width: 90px; height: 90px;
      position: relative;
    }
    .wind-compass-wrap svg { width: 100%; height: 100%; }

    /* Top Picks section */
    .planner-picks-title {
      font-size: 0.68rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.4);
      margin-bottom: 0.75rem;
    }
    .planner-picks {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      max-height: 520px;
      overflow-y: auto;
      padding-right: 0.25rem;
    }
    .planner-picks::-webkit-scrollbar { width: 4px; }
    .planner-picks::-webkit-scrollbar-thumb { background: rgba(44,188,179,0.3); border-radius: 2px; }
    .planner-picks::-webkit-scrollbar-track { background: transparent; }
    .pick-card {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius);
      padding: 1rem;
      cursor: pointer;
      transition: all var(--transition);
      position: relative;
      overflow: hidden;
    }
    .pick-card:hover {
      background: rgba(44,188,179,0.10);
      border-color: rgba(44,188,179,0.3);
      transform: translateY(-2px);
    }
    .pick-card-match {
      display: inline-block;
      font-size: 0.72rem;
      font-weight: 800;
      font-family: var(--font-mono);
      color: var(--teal-light);
      background: rgba(44,188,179,0.15);
      padding: 0.15rem 0.5rem;
      border-radius: 20px;
      margin-bottom: 0.5rem;
    }
    .pick-card-name {
      font-size: 0.92rem;
      font-weight: 700;
      color: white;
      line-height: 1.25;
      margin-bottom: 0.35rem;
    }
    .pick-card-meta {
      font-size: 0.72rem;
      color: rgba(255,255,255,0.5);
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 0.4rem;
    }
    .pick-card-wind {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 0.15rem 0.5rem;
      border-radius: 20px;
    }
    .pick-wind-tail { background: rgba(16,185,129,0.15); color: #34d399; }
    .pick-wind-favour { background: rgba(245,158,11,0.15); color: #fbbf24; }
    .pick-wind-cross { background: rgba(251,146,60,0.15); color: #fb923c; }
    .pick-wind-head { background: rgba(239,68,68,0.15); color: #f87171; }
    .pick-card-cafe {
      font-size: 0.7rem;
      color: rgba(255,255,255,0.45);
      margin-top: 0.3rem;
    }
    .planner-no-weather {
      text-align: center;
      padding: 1.5rem;
      color: rgba(255,255,255,0.4);
      font-size: 0.85rem;
    }

    @media (max-width: 800px) {
      .ride-planner-inner {
        grid-template-columns: 1fr;
        gap: 1.25rem;
      }
      .planner-weather-card { order: -1; }
      .planner-picks { grid-template-columns: 1fr; }
    }
    @media (min-width: 801px) and (max-width: 1024px) {
      .planner-picks { grid-template-columns: repeat(2, 1fr); }
    }

    /* ─── FIND MY RIDE ──────────────────────────────────────────── */
    .find-ride {
      background: var(--dark-deep);
      border-top: 1px solid rgba(44,188,179,0.15);
    }
    .find-ride-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0;
    }
    .find-ride-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      background: none;
      border: none;
      color: white;
      padding: 1rem 1.5rem;
      cursor: pointer;
      font-family: var(--font-main);
      transition: background var(--transition);
    }
    .find-ride-toggle:hover {
      background: rgba(44,188,179,0.06);
    }
    .find-ride-toggle-left {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }
    .find-ride-toggle-icon {
      font-size: 1.1rem;
    }
    .find-ride-toggle-title {
      font-size: 0.82rem;
      font-weight: 700;
      letter-spacing: 0.04em;
    }
    .find-ride-toggle-sub {
      font-size: 0.7rem;
      color: rgba(255,255,255,0.4);
      margin-left: 0.5rem;
    }
    .find-ride-chevron {
      font-size: 0.75rem;
      color: var(--teal);
      transition: transform var(--transition);
    }
    .find-ride.open .find-ride-chevron {
      transform: rotate(180deg);
    }
    .find-ride-panel {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .find-ride.open .find-ride-panel {
      max-height: 600px;
    }
    .find-ride-content {
      padding: 0 1.5rem 1.5rem;
    }
    .find-ride-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1.25rem;
    }
    .find-ride-field {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .find-ride-label {
      font-size: 0.68rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.5);
    }
    .find-ride-slider-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .find-ride-slider {
      flex: 1;
      -webkit-appearance: none;
      height: 4px;
      border-radius: 2px;
      background: rgba(255,255,255,0.12);
      outline: none;
    }
    .find-ride-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px; height: 18px;
      border-radius: 50%;
      background: var(--teal);
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 6px rgba(0,0,0,.3);
    }
    .find-ride-slider::-moz-range-thumb {
      width: 18px; height: 18px;
      border-radius: 50%;
      background: var(--teal);
      cursor: pointer;
      border: 2px solid white;
    }
    .find-ride-slider-val {
      font-size: 0.88rem;
      font-weight: 800;
      color: var(--teal-light);
      font-family: var(--font-mono);
      min-width: 48px;
      text-align: right;
    }
    .find-ride-options {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }
    .find-ride-opt {
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      font-size: 0.72rem;
      font-weight: 600;
      background: rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.6);
      border: 1px solid rgba(255,255,255,0.1);
      cursor: pointer;
      transition: all var(--transition);
      font-family: var(--font-main);
    }
    .find-ride-opt:hover {
      background: rgba(44,188,179,0.15);
      border-color: rgba(44,188,179,0.3);
      color: white;
    }
    .find-ride-opt.active {
      background: var(--teal);
      color: white;
      border-color: var(--teal);
    }
    .find-ride-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-top: 1.25rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    .find-ride-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.6rem 1.5rem;
      border-radius: var(--radius-sm);
      font-size: 0.82rem;
      font-weight: 700;
      background: var(--teal);
      color: white;
      border: none;
      cursor: pointer;
      transition: all var(--transition);
      font-family: var(--font-main);
      letter-spacing: 0.02em;
    }
    .find-ride-btn:hover {
      background: var(--teal-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(44,188,179,0.3);
    }
    .find-ride-btn:active {
      transform: scale(0.97);
    }
    .find-ride-reset {
      background: none;
      border: none;
      color: rgba(255,255,255,0.4);
      font-size: 0.72rem;
      cursor: pointer;
      font-family: var(--font-main);
      padding: 0.4rem 0.6rem;
      border-radius: var(--radius-sm);
      transition: color var(--transition);
    }
    .find-ride-reset:hover {
      color: white;
    }
    .find-ride-result-msg {
      font-size: 0.78rem;
      color: var(--teal-light);
      margin-left: auto;
      font-weight: 600;
    }
    @media (max-width: 600px) {
      .find-ride-grid {
        grid-template-columns: 1fr;
      }
      .find-ride-toggle-sub { display: none; }
    }

    /* ─── ROUTE COMPARISON ───────────────────────────────────────── */
    .compare-toggle {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.3rem 0.65rem;
      border-radius: 20px;
      font-size: 0.68rem;
      font-weight: 600;
      background: rgba(44,188,179,0.08);
      color: var(--grey-400);
      border: 1px solid rgba(44,188,179,0.15);
      cursor: pointer;
      transition: all var(--transition);
      font-family: var(--font-main);
      white-space: nowrap;
    }
    .compare-toggle:hover {
      background: rgba(44,188,179,0.15);
      color: var(--teal-dark);
      border-color: var(--teal);
    }
    .compare-toggle.active {
      background: var(--teal);
      color: white;
      border-color: var(--teal);
    }
    .compare-toggle .compare-check {
      width: 14px; height: 14px;
      border-radius: 3px;
      border: 2px solid currentColor;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      line-height: 1;
      flex-shrink: 0;
    }
    .compare-toggle.active .compare-check {
      background: white;
      color: var(--teal);
      border-color: white;
    }

    /* Floating comparison bar */
    .compare-bar {
      position: fixed;
      bottom: -80px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--dark);
      border: 1px solid rgba(44,188,179,0.3);
      border-radius: var(--radius);
      padding: 0.75rem 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 0 1px rgba(44,188,179,0.1);
      z-index: 1000;
      transition: bottom 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      max-width: 90vw;
    }
    .compare-bar.visible {
      bottom: 24px;
    }
    .compare-bar-chips {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }
    .compare-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.3rem 0.6rem;
      border-radius: 20px;
      font-size: 0.72rem;
      font-weight: 600;
      background: rgba(44,188,179,0.15);
      color: var(--teal-light);
      white-space: nowrap;
    }
    .compare-chip-remove {
      background: none;
      border: none;
      color: rgba(255,255,255,0.5);
      cursor: pointer;
      font-size: 0.8rem;
      padding: 0;
      line-height: 1;
      font-family: var(--font-main);
    }
    .compare-chip-remove:hover { color: white; }
    .compare-bar-btn {
      padding: 0.5rem 1.2rem;
      border-radius: var(--radius-sm);
      font-size: 0.78rem;
      font-weight: 700;
      background: var(--teal);
      color: white;
      border: none;
      cursor: pointer;
      white-space: nowrap;
      transition: all var(--transition);
      font-family: var(--font-main);
    }
    .compare-bar-btn:hover {
      background: var(--teal-dark);
    }
    .compare-bar-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* Comparison modal/panel */
    .compare-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 2000;
      backdrop-filter: blur(4px);
    }
    .compare-overlay.visible { display: flex; align-items: center; justify-content: center; }
    .compare-modal {
      background: white;
      border-radius: var(--radius);
      width: 95vw;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 24px 64px rgba(0,0,0,0.3);
    }
    .compare-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--grey-100);
      position: sticky;
      top: 0;
      background: white;
      z-index: 1;
      border-radius: var(--radius) var(--radius) 0 0;
    }
    .compare-header h3 {
      font-size: 1rem;
      font-weight: 800;
      color: var(--dark);
      margin: 0;
    }
    .compare-close {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      color: var(--grey-400);
      padding: 0.3rem;
      border-radius: var(--radius-sm);
      transition: color var(--transition);
      font-family: var(--font-main);
    }
    .compare-close:hover { color: var(--dark); }
    .compare-table {
      width: 100%;
      border-collapse: collapse;
    }
    .compare-table th {
      text-align: left;
      font-size: 0.68rem;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--grey-400);
      padding: 0.6rem 1rem;
      background: var(--grey-50);
      border-bottom: 1px solid var(--grey-100);
      white-space: nowrap;
      width: 120px;
    }
    .compare-table td {
      padding: 0.6rem 1rem;
      font-size: 0.82rem;
      color: var(--dark);
      border-bottom: 1px solid var(--grey-50);
      text-align: center;
      font-weight: 500;
    }
    .compare-table td:first-child {
      text-align: left;
      font-weight: 700;
      color: var(--dark);
    }
    .compare-table .compare-route-name {
      font-weight: 800;
      font-size: 0.88rem;
      color: var(--dark);
    }
    .compare-table .compare-best {
      color: var(--teal-dark);
      font-weight: 700;
    }
    .compare-table .compare-wind-cell {
      font-size: 0.72rem;
      font-weight: 700;
    }
    .compare-elev-wrap {
      padding: 1rem 1.5rem 1.5rem;
      border-top: 1px solid var(--grey-100);
    }
    .compare-elev-title {
      font-size: 0.72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--grey-400);
      margin-bottom: 0.75rem;
    }
    .compare-elev-chart {
      height: 180px;
      position: relative;
    }
    @media (max-width: 600px) {
      .compare-modal { width: 100vw; max-height: 100vh; border-radius: 0; }
      .compare-table th, .compare-table td { padding: 0.5rem 0.6rem; font-size: 0.72rem; }
      .compare-bar { max-width: 95vw; padding: 0.6rem 0.8rem; }
    }

    /* ─── FOOTER ─────────────────────────────────────────────────── */
    .site-footer {
      background: var(--dark-deep);
      color: rgba(255,255,255,0.35);
      text-align: center;
      font-size: 0.72rem;
      padding: 1.5rem;
      margin-top: 2rem;
      line-height: 1.6;
    }

    /* Mobile filter toggle */
    .mobile-filter-toggle {
      display: none;
      width: 100%;
      padding: 0.65rem 1rem;
      background: var(--dark);
      color: white;
      font-size: 0.85rem;
      font-weight: 700;
      border-radius: var(--radius);
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .mobile-filter-toggle span { font-size: 0.75rem; background: var(--teal); border-radius: 20px; padding: 0.15rem 0.5rem; }

    /* ─── RESPONSIVE ─────────────────────────────────────────────── */
    @media (max-width: 800px) {
      .app-body {
        grid-template-columns: 1fr;
        padding: 1rem;
        gap: 0;
      }
      .sidebar {
        position: static;
        margin-bottom: 1rem;
      }
      .sidebar-body { display: none; }
      .sidebar-body.open { display: block; }
      .mobile-filter-toggle { display: flex; }
      .hero { padding: 1.5rem 1rem; }
      .hero-stats { gap: 1rem; }
      .stats-bar { flex-wrap: wrap; }
      .stats-bar-item { min-width: 60px; }
      .card-meta { grid-template-columns: repeat(3, 1fr); }
    }

    @media (max-width: 480px) {
      .card-actions { gap: 0.4rem; }
      .action-btn { padding: 0.4rem 0.65rem; font-size: 0.73rem; }
      .card-meta { grid-template-columns: repeat(2, 1fr); }
    }

    /* Hash highlight animation */
    @keyframes highlightPulse {
      0%   { box-shadow: 0 0 0 4px var(--teal); }
      70%  { box-shadow: 0 0 0 8px rgba(44,188,179,0); }
      100% { box-shadow: none; }
    }
    .route-card.pulse { animation: highlightPulse 1.2s ease-out; }

    .tooltip { position: relative; }
    .tooltip[data-tip]:hover::after {
      content: attr(data-tip);
      position: absolute;
      bottom: calc(100% + 6px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--dark-deep);
      color: white;
      font-size: 0.7rem;
      white-space: nowrap;
      padding: 0.3rem 0.6rem;
      border-radius: var(--radius-xs);
      pointer-events: none;
      z-index: 200;
    }
  </style>
</head>

<body>

<!-- ── HEADER ────────────────────────────────────────────────────── -->
<header class="site-header">
  <div class="brand">
    <div class="logo-icon">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M5 17a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm0 1a4 4 0 1 1 0-8 4 4 0 0 1 0 8Zm14-1a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm0 1a4 4 0 1 1 0-8 4 4 0 0 1 0 8ZM12 7.5l-3 3.5h6V9.5l2 1.5H12.5L15 7.5H12Zm-1-1.5h5l-2.5 3H17l3 2.25-3.5.25V13H9.5L8 11h2L12 8l-1-2Z"/>
      </svg>
    </div>
    <div>
      <div class="brand-name">SOCC</div>
      <div class="brand-sub">Swavesey & Over Cycling Club</div>
    </div>
  </div>
  <div class="header-tag">Route Finder</div>
</header>

<!-- ── HERO ──────────────────────────────────────────────────────── -->
<section class="hero">
  <div class="hero-inner">
    <h1>Find your next <span>SOCC</span> ride</h1>
    <p class="hero-sub">Cambridgeshire routes, handpicked by the club — updated live from our route sheet</p>
    <div class="hero-stats">
      <div class="hero-stat">
        <div class="num" id="hero-total">—</div>
        <div class="label">Routes available</div>
      </div>
      <div class="hero-stat">
        <div class="num" id="hero-road">—</div>
        <div class="label">Road</div>
      </div>
      <div class="hero-stat">
        <div class="num" id="hero-mtb">—</div>
        <div class="label">MTB</div>
      </div>
      <div class="hero-stat">
        <div class="num" id="hero-gravel">—</div>
        <div class="label">Gravel</div>
      </div>
    </div>
  </div>
</section>

<!-- ── WEATHER STRIP ──────────────────────────────────────────── -->
<div class="weather-strip" id="weatherStrip">
  <div class="weather-loading">Loading 7-day forecast...</div>
</div>

<!-- ── RIDE PLANNER ──────────────────────────────────────────── -->
<section class="ride-planner" id="ridePlanner">
  <div class="ride-planner-inner">
    <div class="planner-main">
      <div class="planner-title">Ride Planner</div>
      <h2 class="planner-heading" id="plannerHeading">This Sunday's Ride</h2>
      <p class="planner-wind-advice" id="plannerAdvice">Loading weather data...</p>

      <div class="planner-controls">
        <span class="planner-control-label">Target distance</span>
        <input type="range" class="planner-slider" id="plannerDist" min="10" max="130" value="40" step="5">
        <span class="planner-slider-val" id="plannerDistVal">40 mi</span>
      </div>

      <div class="planner-picks-title">Routes ranked for Sunday</div>
      <div class="planner-picks" id="plannerPicks">
        <div class="planner-no-weather">Waiting for data...</div>
      </div>
    </div>

    <div class="planner-weather-card" id="plannerWeatherCard">
      <div class="planner-no-weather">Loading weather...</div>
    </div>
  </div>
</section>

<!-- Find My Ride panel -->
<section class="find-ride" id="findMyRide">
  <div class="find-ride-inner">
    <button class="find-ride-toggle" id="findRideToggle" aria-expanded="false" aria-controls="findRidePanel">
      <span class="find-ride-toggle-left">
        <span class="find-ride-toggle-icon">🔍</span>
        <span class="find-ride-toggle-title">Find My Ride</span>
        <span class="find-ride-toggle-sub">Set your preferences and we'll score every route</span>
      </span>
      <span class="find-ride-chevron">▼</span>
    </button>
    <div class="find-ride-panel" id="findRidePanel" role="region">
      <div class="find-ride-content">
        <div class="find-ride-grid">
          <div class="find-ride-field">
            <label class="find-ride-label" for="fmrDist">Target distance</label>
            <div class="find-ride-slider-row">
              <input type="range" class="find-ride-slider" id="fmrDist" min="10" max="130" value="40" step="5">
              <span class="find-ride-slider-val" id="fmrDistVal">40 mi</span>
            </div>
          </div>
          <div class="find-ride-field">
            <label class="find-ride-label" for="fmrTime">Time available</label>
            <div class="find-ride-slider-row">
              <input type="range" class="find-ride-slider" id="fmrTime" min="1" max="8" value="3" step="0.5">
              <span class="find-ride-slider-val" id="fmrTimeVal">3 hrs</span>
            </div>
          </div>
          <div class="find-ride-field">
            <span class="find-ride-label">Cafe stop?</span>
            <div class="find-ride-options" id="fmrCafe" role="radiogroup" aria-label="Cafe preference">
              <button class="find-ride-opt active" data-val="any" role="radio" aria-checked="true">Don't mind</button>
              <button class="find-ride-opt" data-val="yes" role="radio" aria-checked="false">Yes please</button>
              <button class="find-ride-opt" data-val="no" role="radio" aria-checked="false">No thanks</button>
            </div>
          </div>
          <div class="find-ride-field">
            <span class="find-ride-label">Difficulty</span>
            <div class="find-ride-options" id="fmrDifficulty" role="radiogroup" aria-label="Difficulty preference">
              <button class="find-ride-opt" data-val="easy" role="radio" aria-checked="false">Easy</button>
              <button class="find-ride-opt active" data-val="moderate" role="radio" aria-checked="true">Moderate</button>
              <button class="find-ride-opt" data-val="hard" role="radio" aria-checked="false">Challenge</button>
            </div>
          </div>
          <div class="find-ride-field">
            <span class="find-ride-label">Route type</span>
            <div class="find-ride-options" id="fmrType" role="radiogroup" aria-label="Route type preference">
              <button class="find-ride-opt active" data-val="any" role="radio" aria-checked="true">Any</button>
              <button class="find-ride-opt" data-val="Road" role="radio" aria-checked="false">Road</button>
              <button class="find-ride-opt" data-val="MTB" role="radio" aria-checked="false">MTB</button>
              <button class="find-ride-opt" data-val="Gravel" role="radio" aria-checked="false">Gravel</button>
            </div>
          </div>
          <div class="find-ride-field">
            <span class="find-ride-label">Busway</span>
            <div class="find-ride-options" id="fmrBusway" role="radiogroup" aria-label="Busway preference">
              <button class="find-ride-opt active" data-val="any" role="radio" aria-checked="true">Don't mind</button>
              <button class="find-ride-opt" data-val="avoid" role="radio" aria-checked="false">Avoid</button>
            </div>
          </div>
        </div>
        <div class="find-ride-actions">
          <button class="find-ride-btn" id="fmrSearch">🔍 Find routes</button>
          <button class="find-ride-reset" id="fmrReset">Reset all</button>
          <span class="find-ride-result-msg" id="fmrResultMsg"></span>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- DEBUG PANEL — remove once working -->
<div id="debugPanel" style="background:#111B24;color:#e8f0fe;font-family:monospace;font-size:0.78rem;padding:1rem 1.5rem;border-bottom:3px solid #2CBCB3;display:none">
  <div style="max-width:1280px;margin:0 auto">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.6rem">
      <strong style="color:#2CBCB3;font-size:0.85rem;">🔧 Debug Panel — remove once working</strong>
      <button onclick="document.getElementById('debugPanel').remove()" style="background:rgba(255,255,255,0.1);border:none;color:white;padding:0.2rem 0.6rem;border-radius:4px;cursor:pointer;font-size:0.75rem">✕ Hide</button>
    </div>
    <div id="debugLog" style="display:flex;flex-direction:column;gap:0.3rem;"></div>
  </div>
</div>
<script>
  // Hide debug panel immediately if SHOW_DEBUG is false — avoids flash of panel on load
  // (CONFIG is defined later in the main script block, so we check a data attribute instead)
  document.getElementById('debugPanel').dataset.managed = '1';
</script>

<!-- ── APP BODY ───────────────────────────────────────────────────── -->
<main class="app-body">

  <!-- Sidebar -->
  <aside class="sidebar">
    <button class="mobile-filter-toggle" id="filterToggle">
      ⚙️ Filter Routes
      <span id="activeFilterCount">0</span>
    </button>
    <div class="sidebar-header">
      <span class="sidebar-title">Filters</span>
      <span class="result-count" id="resultCount">— routes</span>
    </div>
    <div class="sidebar-body" id="sidebarBody">

      <div style="padding-top:0.75rem">
        <!-- Type -->
        <div class="filter-group">
          <span class="filter-label">Type</span>
          <div class="toggle-group" id="typeToggle">
            <button class="toggle-btn active" data-val="all">All</button>
            <button class="toggle-btn" data-val="Road">🚴 Road</button>
            <button class="toggle-btn" data-val="MTB">🚵 MTB</button>
            <button class="toggle-btn" data-val="Gravel">🏕️ Gravel</button>
          </div>
        </div>

        <!-- Distance -->
        <div class="filter-group">
          <span class="filter-label">Distance (miles)</span>
          <div class="range-group">
            <div class="range-row">
              <span style="font-size:0.7rem;color:var(--grey-400);width:20px">Min</span>
              <input type="range" id="distMin" min="0" max="160" value="0" step="1">
              <span class="range-val" id="distMinVal">0 mi</span>
            </div>
            <div class="range-row">
              <span style="font-size:0.7rem;color:var(--grey-400);width:20px">Max</span>
              <input type="range" id="distMax" min="0" max="160" value="160" step="5">
              <span class="range-val" id="distMaxVal">100 mi</span>
            </div>
          </div>
        </div>

        <!-- Ascent -->
        <div class="filter-group">
          <span class="filter-label">Ascent (metres)</span>
          <div class="range-group">
            <div class="range-row">
              <span style="font-size:0.7rem;color:var(--grey-400);width:20px">Min</span>
              <input type="range" id="ascentMin" min="0" max="1000" value="0" step="10">
              <span class="range-val" id="ascentMinVal">0 m</span>
            </div>
            <div class="range-row">
              <span style="font-size:0.7rem;color:var(--grey-400);width:20px">Max</span>
              <input type="range" id="ascentMax" min="0" max="2500" value="2500" step="25">
              <span class="range-val" id="ascentMaxVal">1000 m</span>
            </div>
          </div>
        </div>

        <!-- Direction -->
        <div class="filter-group">
          <span class="filter-label">Direction</span>
          <div class="checkbox-grid" id="dirChecks">
            <label class="check-item"><input type="checkbox" value="N" checked> N</label>
            <label class="check-item"><input type="checkbox" value="NE" checked> NE</label>
            <label class="check-item"><input type="checkbox" value="E" checked> E</label>
            <label class="check-item"><input type="checkbox" value="SE" checked> SE</label>
            <label class="check-item"><input type="checkbox" value="S" checked> S</label>
            <label class="check-item"><input type="checkbox" value="SW" checked> SW</label>
            <label class="check-item"><input type="checkbox" value="W" checked> W</label>
            <label class="check-item"><input type="checkbox" value="NW" checked> NW</label>
          </div>
        </div>

        <!-- Map display -->
        <div class="filter-group">
          <span class="filter-label">Map display</span>
          <div class="toggle-group" id="mapDisplayToggle">
            <button class="toggle-btn active" data-val="all">All</button>
            <button class="toggle-btn" data-val="routes">🚴 Routes</button>
            <button class="toggle-btn" data-val="cafes">🍳 Cafés</button>
          </div>
        </div>

        <!-- Toggles -->
        <div class="filter-group">
          <span class="filter-label">Options</span>
          <div class="switch-row">
            <span class="switch-label">🚌 Exclude busway</span>
            <label class="switch">
              <input type="checkbox" id="buswayToggle">
              <span class="switch-track"></span>
            </label>
          </div>
        </div>

        <!-- Sort -->
        <div class="filter-group">
          <span class="filter-label">Sort by</span>
          <select class="sort-select" id="sortSelect">
            <option value="name">Name A–Z</option>
            <option value="dist_asc">Distance ↑</option>
            <option value="dist_desc">Distance ↓</option>
            <option value="ascent">Ascent ↑</option>
            <option value="last_ridden">Last Ridden</option>
          </select>
        </div>

        <button class="reset-btn" id="resetBtn">↺ Reset all filters</button>
        <button class="reset-btn" onclick="clearCache()" style="margin-top:0.4rem;font-size:0.72rem;">
          🔄 Refresh route data
        </button>
        <div id="cacheAge" style="font-size:0.68rem;color:var(--grey-400);text-align:center;margin-top:0.4rem;"></div>
      </div>
    </div>
  </aside>

  <!-- Cards / Map -->
  <section class="cards-area">

    <!-- View toggle tabs -->
    <div class="view-tabs">
      <button class="view-tab active" id="tabList" onclick="switchView('list')">📋 List</button>
      <button class="view-tab"        id="tabMap"  onclick="switchView('map')">🗺️ Map</button>
    </div>

    <!-- List view -->
    <div id="listPanel">
      <div id="routesGrid" class="routes-grid">
        <div class="loading-state">
          <div class="spinner"></div>
          <p>Loading routes from the club sheet…</p>
        </div>
      </div>
    </div>

    <!-- Master map view -->
    <div id="masterMapPanel">
      <div id="masterMap"></div>
    </div>

  </section>


</main>

<!-- ── COMPARISON BAR & MODAL ─────────────────────────────────────── -->
<div class="compare-bar" id="compareBar">
  <div class="compare-bar-chips" id="compareChips"></div>
  <button class="compare-bar-btn" id="compareBtn" disabled>Compare →</button>
</div>

<div class="compare-overlay" id="compareOverlay">
  <div class="compare-modal" id="compareModal">
    <div class="compare-header">
      <h3>Route Comparison</h3>
      <button class="compare-close" id="compareClose" aria-label="Close comparison">✕</button>
    </div>
    <div id="compareBody"></div>
  </div>
</div>

<!-- ── FOOTER ─────────────────────────────────────────────────────── -->
<footer class="site-footer">
  SOCC — Swavesey & Over Cycling Club &nbsp;|&nbsp;
  Route data maintained by club organisers &nbsp;|&nbsp;
  Map data © <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener noreferrer" style="color:rgba(255,255,255,0.55)">OpenStreetMap</a> contributors
</footer>

<!-- ─── SCRIPTS ──────────────────────────────────────────────────── -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>

<script>
/* ════════════════════════════════════════════════════════════════════
   CONFIG — Update these to point to your Google Sheet
   ════════════════════════════════════════════════════════════════════ */
const CONFIG = {
  SHEET_ID:      '2PACX-1vQflvwcr6Nf1NVyvv45Jt7YWF3fxZO0ecaN8JwMYU4gQeghoYR7eLmkGS7zfSqdlA8VuiIhkQ4eCAYz',
  SHEET_NAME:    'Routes',
  SHEET_GID:     '429694098',
  CAFES_GID:     '2092417686',           // Cafes tab
  USE_DEMO_DATA: false,
  SHOW_DEBUG:    false,          // true = show debug panel; false = hidden
  WEATHER_ENABLED: true,         // true = fetch 7-day forecast from Open-Meteo
  DEFAULT_RIDE_DAY: 'sunday',    // day the club typically rides
  TARGET_DISTANCE: 40,           // default target distance in miles for ride planner

  // Maps your actual sheet column headers → internal app field names (all lowercase keys)
  COLUMN_MAP: {
    'type':                            'type',           // 3rd column: Road/MTB
    'ridable':                        'rideable',
    'route name':                     'route_name',
    'distance miles':                 'distance_miles',
    'ascent (per garmin)':            'ascent_metres',
    'garmin connect link':            'garmin_link',
    'last ride':                      'last_ridden',
    'busway segment':                 'busway_segment',
    'speed':                          'recommended_speed_mph',
    'time':                           'estimated_time_raw',  // decimal hours e.g. 1.746 — converted below
    'time inc 30 minute coffee stop': 'time_with_coffee',
    'roy group':                      'roy_group',
    'new routes number':              'route_number',
    'debrief':                        'notes_debrief',
    'direction':                      'direction',
    'notes':                          'notes',
    'source':                         'source',
    'comparison':                     'comparison',
    'start_lat':                      'start_lat',
    'start_long':                     'start_lon',      // CSV header is 'start_long'
  },

  // Maps Cafes tab column headers → internal field names
  CAFE_COLUMN_MAP: {
    'n1':                    'route_ref',
    'village':               'village',
    'name':                  'cafe_name',
    'rating':                'rating',
    'notes':                 'notes',
    'saturday':              'saturday_hours',
    'sunday opening time':   'sunday_hours',
    'lat':                   'lat',
    'long':                  'lon',
    'website':               'website',
  },
};

/* ════════════════════════════════════════════════════════════════════
   DEMO DATA — Representative sample for development / preview
   ════════════════════════════════════════════════════════════════════ */
const DEMO_ROUTES = [
  {
    route_name: "Johnson's Old Hurst",
    type: "Road", direction: "NW",
    distance_miles: 27.07, ascent_metres: 119,
    estimated_time: "1 h 45 min", time_with_coffee: "2 h 15 min",
    recommended_speed_mph: 15.5,
    cafe_name: "Johnson's Coffee Shop",
    cafe_hours: "Tue–Fri 7am–4pm, Sat–Sun 9am–2pm, Closed Mon",
    cafe_maps_url: "https://maps.google.com/?q=52.36,-0.09",
    garmin_link: "https://connect.garmin.com",
    gpx_url: "",
    start_lat: 52.3063, start_lon: -0.0005,
    last_ridden: "10 Jan", rideable: true,
    busway_segment: false,
    notes: "",
    source: "Roy's route", date_added: "2024-01-01",
  },
  {
    route_name: "Ely Cathedral Loop",
    type: "Road", direction: "N",
    distance_miles: 38.4, ascent_metres: 85,
    estimated_time: "2 h 30 min", time_with_coffee: "3 h 00 min",
    recommended_speed_mph: 15,
    cafe_name: "Peacocks Tea Room",
    cafe_hours: "Mon–Sun 9am–5pm",
    cafe_maps_url: "https://maps.google.com/?q=52.398,0.264",
    garmin_link: "https://connect.garmin.com",
    gpx_url: "",
    start_lat: 52.3063, start_lon: -0.0005,
    last_ridden: "3 Feb", rideable: true,
    busway_segment: true,
    notes: "Pothole on the A10 approach near Stretham — keep right",
    source: "Club route", date_added: "2024-02-01",
  },
  {
    route_name: "St Ives Riverside",
    type: "Road", direction: "NW",
    distance_miles: 22.5, ascent_metres: 60,
    estimated_time: "1 h 30 min", time_with_coffee: "2 h 00 min",
    recommended_speed_mph: 14,
    cafe_name: "The Bridge Café",
    cafe_hours: "Sat–Sun 8am–3pm only",
    cafe_maps_url: "https://maps.google.com/?q=52.33,-0.07",
    garmin_link: "",
    gpx_url: "",
    start_lat: 52.3063, start_lon: -0.0005,
    last_ridden: "", rideable: true,
    busway_segment: true,
    notes: "Roadworks at Fen Drayton junction until end of March",
    source: "Roy's route", date_added: "2024-03-01",
  },
  {
    route_name: "Gog Magog Gravel",
    type: "Gravel", direction: "SE",
    distance_miles: 31.2, ascent_metres: 310,
    estimated_time: "2 h 20 min", time_with_coffee: "2 h 50 min",
    recommended_speed_mph: 13,
    cafe_name: "Gog Farm Shop Café",
    cafe_hours: "Mon–Sun 9am–4pm",
    cafe_maps_url: "https://maps.google.com/?q=52.16,0.18",
    garmin_link: "https://connect.garmin.com",
    gpx_url: "",
    start_lat: 52.3063, start_lon: -0.0005,
    last_ridden: "18 Jan", rideable: true,
    busway_segment: false,
    notes: "",
    source: "Club route", date_added: "2024-03-15",
  },
  {
    route_name: "Huntingdon Flat 50",
    type: "Road", direction: "W",
    distance_miles: 51.8, ascent_metres: 145,
    estimated_time: "3 h 20 min", time_with_coffee: "3 h 55 min",
    recommended_speed_mph: 15.5,
    cafe_name: "",
    cafe_hours: "",
    cafe_maps_url: "",
    garmin_link: "https://connect.garmin.com",
    gpx_url: "",
    start_lat: 52.3063, start_lon: -0.0005,
    last_ridden: "22 Dec", rideable: true,
    busway_segment: false,
    notes: "",
    source: "Roy's route", date_added: "2023-12-01",
  },
  {
    route_name: "Grafham Water Circuit",
    type: "Gravel", direction: "W",
    distance_miles: 19.8, ascent_metres: 95,
    estimated_time: "1 h 25 min", time_with_coffee: "1 h 55 min",
    recommended_speed_mph: 13.5,
    cafe_name: "Grafham Visitor Centre Café",
    cafe_hours: "Sat–Sun 10am–4pm",
    cafe_maps_url: "https://maps.google.com/?q=52.29,-0.29",
    garmin_link: "",
    gpx_url: "",
    start_lat: 52.3063, start_lon: -0.0005,
    last_ridden: "5 Jan", rideable: true,
    busway_segment: false,
    notes: "",
    source: "Club route", date_added: "2024-01-05",
  },
  {
    route_name: "Newmarket Heath Blast",
    type: "Road", direction: "E",
    distance_miles: 44.3, ascent_metres: 180,
    estimated_time: "2 h 50 min", time_with_coffee: "3 h 25 min",
    recommended_speed_mph: 16,
    cafe_name: "The National Stud Café",
    cafe_hours: "Mon–Fri 9am–3pm",
    cafe_maps_url: "https://maps.google.com/?q=52.23,0.39",
    garmin_link: "https://connect.garmin.com",
    gpx_url: "",
    start_lat: 52.3063, start_lon: -0.0005,
    last_ridden: "12 Nov", rideable: true,
    busway_segment: false,
    notes: "",
    source: "Roy's route", date_added: "2023-11-01",
  },
  {
    route_name: "Wicken Fen Explorer",
    type: "Gravel", direction: "NE",
    distance_miles: 28.9, ascent_metres: 48,
    estimated_time: "2 h 10 min", time_with_coffee: "2 h 40 min",
    recommended_speed_mph: 13,
    cafe_name: "Wicken Fen Visitor Centre",
    cafe_hours: "Mon–Sun 10am–4pm (seasonal)",
    cafe_maps_url: "https://maps.google.com/?q=52.30,0.30",
    garmin_link: "",
    gpx_url: "",
    start_lat: 52.3063, start_lon: -0.0005,
    last_ridden: "8 Feb", rideable: true,
    busway_segment: false,
    notes: "",
    source: "Club route", date_added: "2024-02-08",
  },
];

const DEMO_CAFES = [
  { route_ref: "5 Miles from Anywhere (58)", village: "upware", cafe_name: "5 Miles from Anywhere", rating: "", notes: "", saturday_hours: "11:00", sunday_hours: "11:00", lat: 52.307786, lon: 0.252429, website: "http://www.fivemilesinn.com/" },
  { route_ref: "Amor Cafe-Hardwick", village: "Hardwick", cafe_name: "Amor", rating: 4, notes: "", saturday_hours: "09:00", sunday_hours: "09:00", lat: 52.217456, lon: 0.01047, website: "https://amorcoffeecompany.co.uk/" },
  { route_ref: "Ambience Cafe (50)", village: "St Neots", cafe_name: "Ambience", rating: "", notes: "", saturday_hours: "09:00", sunday_hours: "09:00", lat: 52.226005, lon: -0.274664, website: "http://www.ambiancecafe.co.uk/" },
];

/* ════════════════════════════════════════════════════════════════════
   WEATHER — Open-Meteo API (free, no API key, CORS-enabled)
   ════════════════════════════════════════════════════════════════════ */
const WEATHER_CACHE_KEY = 'socc_weather_cache';
const WEATHER_CACHE_TTL = 30 * 60 * 1000; // 30 minutes

// WMO Weather Code → icon + description mapping
const WMO_CODES = {
  0: { icon: '☀️', desc: 'Clear sky' },
  1: { icon: '🌤️', desc: 'Mainly clear' },
  2: { icon: '⛅', desc: 'Partly cloudy' },
  3: { icon: '☁️', desc: 'Overcast' },
  45: { icon: '🌫️', desc: 'Foggy' },
  48: { icon: '🌫️', desc: 'Icy fog' },
  51: { icon: '🌦️', desc: 'Light drizzle' },
  53: { icon: '🌦️', desc: 'Drizzle' },
  55: { icon: '🌧️', desc: 'Heavy drizzle' },
  61: { icon: '🌧️', desc: 'Light rain' },
  63: { icon: '🌧️', desc: 'Rain' },
  65: { icon: '🌧️', desc: 'Heavy rain' },
  66: { icon: '🌨️', desc: 'Freezing rain' },
  67: { icon: '🌨️', desc: 'Heavy freezing rain' },
  71: { icon: '🌨️', desc: 'Light snow' },
  73: { icon: '🌨️', desc: 'Snow' },
  75: { icon: '❄️', desc: 'Heavy snow' },
  77: { icon: '🌨️', desc: 'Snow grains' },
  80: { icon: '🌦️', desc: 'Light showers' },
  81: { icon: '🌧️', desc: 'Showers' },
  82: { icon: '⛈️', desc: 'Heavy showers' },
  85: { icon: '🌨️', desc: 'Snow showers' },
  86: { icon: '❄️', desc: 'Heavy snow showers' },
  95: { icon: '⛈️', desc: 'Thunderstorm' },
  96: { icon: '⛈️', desc: 'Thunderstorm + hail' },
  99: { icon: '⛈️', desc: 'Thunderstorm + heavy hail' },
};

function degreesToCompass(deg) {
  const dirs = ['N','NE','E','SE','S','SW','W','NW'];
  return dirs[Math.round(deg / 45) % 8];
}

const DEMO_WEATHER = {
  daily: [
    { date: '2026-03-01', dayName: 'Sunday', tempMax: 11, tempMin: 4, windSpeed: 14, windDir: 210, windDirLabel: 'SW', rainProb: 25, weatherCode: 2, icon: '⛅', desc: 'Partly cloudy' },
    { date: '2026-03-02', dayName: 'Monday', tempMax: 9, tempMin: 3, windSpeed: 18, windDir: 240, windDirLabel: 'WSW', rainProb: 60, weatherCode: 61, icon: '🌧️', desc: 'Light rain' },
    { date: '2026-03-03', dayName: 'Tuesday', tempMax: 10, tempMin: 5, windSpeed: 12, windDir: 180, windDirLabel: 'S', rainProb: 35, weatherCode: 3, icon: '☁️', desc: 'Overcast' },
    { date: '2026-03-04', dayName: 'Wednesday', tempMax: 12, tempMin: 6, windSpeed: 8, windDir: 150, windDirLabel: 'SE', rainProb: 10, weatherCode: 1, icon: '🌤️', desc: 'Mainly clear' },
    { date: '2026-03-05', dayName: 'Thursday', tempMax: 13, tempMin: 7, windSpeed: 10, windDir: 90, windDirLabel: 'E', rainProb: 15, weatherCode: 0, icon: '☀️', desc: 'Clear sky' },
    { date: '2026-03-06', dayName: 'Friday', tempMax: 11, tempMin: 5, windSpeed: 16, windDir: 270, windDirLabel: 'W', rainProb: 45, weatherCode: 80, icon: '🌦️', desc: 'Light showers' },
    { date: '2026-03-07', dayName: 'Saturday', tempMax: 10, tempMin: 4, windSpeed: 20, windDir: 315, windDirLabel: 'NW', rainProb: 55, weatherCode: 63, icon: '🌧️', desc: 'Rain' },
  ],
  sunday: null, // set during parsing
  lastFetched: Date.now(),
};
DEMO_WEATHER.sunday = DEMO_WEATHER.daily[0];

async function fetchWeather() {
  if (!CONFIG.WEATHER_ENABLED) return null;

  if (CONFIG.USE_DEMO_DATA) {
    dbg('Weather: using demo data', true);
    return DEMO_WEATHER;
  }

  // Check cache
  try {
    const cached = JSON.parse(localStorage.getItem(WEATHER_CACHE_KEY));
    if (cached && (Date.now() - cached.lastFetched < WEATHER_CACHE_TTL)) {
      dbg(`Weather cache hit — ${Math.floor((Date.now() - cached.lastFetched) / 60000)} min old`, true);
      return cached;
    }
  } catch(e) { /* ignore */ }

  // Fetch from Open-Meteo
  const lat = 52.3063, lon = -0.0004; // Swavesey
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`
    + `&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,wind_speed_10m_max,wind_direction_10m_dominant,weathercode`
    + `&wind_speed_unit=mph&timezone=Europe%2FLondon&forecast_days=7`;

  try {
    dbg(`Weather: fetching from Open-Meteo...`);
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();

    const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    const daily = json.daily.time.map((dateStr, i) => {
      const d = new Date(dateStr + 'T12:00:00');
      const wmo = json.daily.weathercode[i];
      const wmoInfo = WMO_CODES[wmo] || { icon: '🌤️', desc: 'Unknown' };
      const windDir = Math.round(json.daily.wind_direction_10m_dominant[i] || 0);
      return {
        date: dateStr,
        dayName: dayNames[d.getDay()],
        tempMax: Math.round(json.daily.temperature_2m_max[i]),
        tempMin: Math.round(json.daily.temperature_2m_min[i]),
        windSpeed: Math.round(json.daily.wind_speed_10m_max[i]),
        windDir: windDir,
        windDirLabel: degreesToCompass(windDir),
        rainProb: Math.round(json.daily.precipitation_probability_max[i] || 0),
        weatherCode: wmo,
        icon: wmoInfo.icon,
        desc: wmoInfo.desc,
      };
    });

    // Find next Sunday (or today if it is Sunday)
    const rideDay = CONFIG.DEFAULT_RIDE_DAY.charAt(0).toUpperCase() + CONFIG.DEFAULT_RIDE_DAY.slice(1);
    const sunday = daily.find(d => d.dayName === rideDay) || daily[0];

    const weather = { daily, sunday, lastFetched: Date.now() };

    // Cache it
    try { localStorage.setItem(WEATHER_CACHE_KEY, JSON.stringify(weather)); } catch(e) { /* quota */ }
    dbg(`Weather fetched — ${daily.length} days, ${rideDay}: ${sunday.icon} ${sunday.tempMax}°C, wind ${sunday.windDirLabel} ${sunday.windSpeed}mph`, true);
    return weather;
  } catch(e) {
    dbg(`Weather fetch failed: ${e.message}`, false);
    return null;
  }
}

/* ════════════════════════════════════════════════════════════════════
   STATE
   ════════════════════════════════════════════════════════════════════ */
let allRoutes = [];
let filteredRoutes = [];
let allCafes = [];
let weatherData = null;  // populated by fetchWeather()
let openMaps = {};   // cardId → leaflet map instance
let filterTimer = null;

const state = {
  type: 'all',
  distMin: 0, distMax: 160,
  ascentMin: 0, ascentMax: 2500,
  directions: new Set(['N','NE','E','SE','S','SW','W','NW']),
  mapDisplay: 'all',  // 'routes' | 'all' | 'cafes'
  excludeBusway: false,
  sort: 'name',
  targetDistance: CONFIG.TARGET_DISTANCE,  // for ride planner
};

/* ════════════════════════════════════════════════════════════════════
   DATA FETCHING — with localStorage cache (1 hour TTL)
   ════════════════════════════════════════════════════════════════════ */
const CACHE_KEY = 'socc_routes_cache';
const CAFES_CACHE_KEY = 'socc_cafes_cache';
const CACHE_TTL = 60 * 60 * 1000; // 1 hour in ms

function dbg(msg, ok) {
  if (!CONFIG.SHOW_DEBUG) return;
  console.log('SOCC DEBUG:', msg);
  const log = document.getElementById('debugLog');
  if (!log) return;
  const row = document.createElement('div');
  row.style.cssText = `padding:0.3rem 0.5rem;border-radius:4px;background:${ok === false ? 'rgba(224,54,54,0.2)' : ok === true ? 'rgba(29,184,122,0.15)' : 'rgba(255,255,255,0.05)'}`;
  row.innerHTML = `<span style="color:${ok === false ? '#f87171' : ok === true ? '#4ade80' : '#93c5fd'}">${ok === false ? '✗' : ok === true ? '✓' : '→'}</span> ${msg}`;
  log.appendChild(row);
}

async function fetchRoutes() {
  dbg(`CONFIG.USE_DEMO_DATA = ${CONFIG.USE_DEMO_DATA}`);
  dbg(`CONFIG.SHEET_ID = ${CONFIG.SHEET_ID.slice(0,20)}...`);
  dbg(`CONFIG.SHEET_GID = ${CONFIG.SHEET_GID}`);

  if (CONFIG.USE_DEMO_DATA) {
    const demo = DEMO_ROUTES.filter(r => r.rideable !== false);
    dbg(`Demo mode — returning ${demo.length} routes`, true);
    return demo;
  }

  // Return cached data if still fresh
  try {
    const cached = JSON.parse(localStorage.getItem(CACHE_KEY));
    if (cached && (Date.now() - cached.timestamp < CACHE_TTL)) {
      const ageMins = Math.floor((Date.now() - cached.timestamp) / 60000);
      dbg(`Cache hit — ${cached.data.length} routes, ${ageMins} min old`, true);
      showCacheAge(cached.timestamp);
      return cached.data;
    } else if (cached) {
      dbg(`Cache expired — fetching fresh`);
    } else {
      dbg(`No cache found — fetching fresh`);
    }
  } catch(e) {
    dbg(`Cache read error: ${e.message}`, false);
  }

  // Fetch fresh from sheet
  const url = `https://docs.google.com/spreadsheets/d/e/${CONFIG.SHEET_ID}/pub?gid=${CONFIG.SHEET_GID}&single=true&output=csv`;
  dbg(`Fetching: ${url.slice(0,80)}...`);

  let res;
  try {
    res = await fetch(url);
    dbg(`HTTP status: ${res.status} ${res.statusText}`, res.ok);
  } catch(e) {
    if (location.protocol === 'file:') {
      dbg('✗ Running as file:// — browsers block fetch() from local files. Serve via http:// instead:', false);
      dbg('  → Option A: run  npx serve .  then open http://localhost:3000', false);
      dbg('  → Option B: run  python3 -m http.server 8080  then open http://localhost:8080', false);
      dbg('  → Option C: VS Code → right-click index.html → Open with Live Server', false);
      dbg('  → Or just deploy to Netlify — it will work fine there', false);
    } else {
      dbg(`Fetch failed (network/CORS): ${e.message}`, false);
    }
    throw e;
  }

  let csv;
  try {
    csv = await res.text();
    dbg(`Response length: ${csv.length} chars`);
    dbg(`First 120 chars: ${csv.slice(0,120).replace(/\n/g,' ')}`);
  } catch(e) {
    dbg(`Failed to read response text: ${e.message}`, false);
    throw e;
  }

  if (csv.length < 10) {
    dbg('Response is empty — sheet may not be published correctly', false);
    throw new Error('Empty CSV response');
  }
  if (csv.toLowerCase().includes('<html')) {
    dbg('Response is HTML not CSV — likely a Google sign-in redirect', false);
    throw new Error('Got HTML instead of CSV');
  }

  let parsed;
  try {
    parsed = parseCSV(csv);
    dbg(`CSV parsed — ${parsed.length} total rows`);
    if (parsed.length > 0) {
      dbg(`Columns detected: ${Object.keys(parsed[0]).join(', ')}`);
    }
  } catch(e) {
    dbg(`CSV parse error: ${e.message}`, false);
    throw e;
  }

  // Check rideable column
  const rideableVals = [...new Set(parsed.map(r => String(r.rideable)))];
  dbg(`'rideable' values found: ${rideableVals.join(', ')}`);

  const data = parsed.filter(r => {
    const rv = String(r.rideable || '').toLowerCase().trim();
    // Hide only if explicitly marked NO/false, or pending (?check cafe, argh, etc.)
    if (r.rideable === false) return false;  // explicit NO
    if (rv === '?check cafe') return false;
    if (rv !== '' && rv !== 'true' && rv !== 'yes' && rv !== 'road' && rv !== 'mtb') return false;
    return true;
  });
  dbg(`Rideable routes: ${data.length} of ${parsed.length}`, data.length > 0);

  if (data.length === 0 && parsed.length > 0) {
    dbg("⚠️ All routes filtered out — 'rideable' column must be YES/TRUE/true. Found: " + rideableVals.join(', '), false);
  } else if (data.length < parsed.length) {
    const excluded = parsed.length - data.length;
    dbg(`ℹ️ ${excluded} rows excluded — rideable is NO/FALSE/empty/?Check cafe etc`);
  }

  try {
    localStorage.setItem(CACHE_KEY, JSON.stringify({ timestamp: Date.now(), data }));
    dbg(`Cached ${data.length} routes to localStorage`, true);
  } catch(e) {
    dbg(`Cache write failed (storage full?): ${e.message}`, false);
  }

  showCacheAge(Date.now());
  return data;
}

async function fetchCafes() {
  if (CONFIG.USE_DEMO_DATA) {
    dbg(`Demo mode — returning ${DEMO_CAFES.length} cafes`, true);
    return DEMO_CAFES;
  }

  // Return cached data if still fresh
  try {
    const cached = JSON.parse(localStorage.getItem(CAFES_CACHE_KEY));
    if (cached && (Date.now() - cached.timestamp < CACHE_TTL)) {
      dbg(`Cafes cache hit — ${cached.data.length} cafes`, true);
      return cached.data;
    }
  } catch(e) { /* ignore */ }

  const url = `https://docs.google.com/spreadsheets/d/e/${CONFIG.SHEET_ID}/pub?gid=${CONFIG.CAFES_GID}&single=true&output=csv`;
  dbg(`Fetching cafes: ${url.slice(0,80)}...`);

  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const csv = await res.text();
    if (csv.length < 10 || csv.toLowerCase().includes('<html')) {
      throw new Error('Invalid CSV response for cafes');
    }
    const parsed = parseCSV(csv, CONFIG.CAFE_COLUMN_MAP);
    // Only keep cafes with valid coordinates
    const data = parsed.filter(c => {
      const lat = parseFloat(c.lat);
      const lon = parseFloat(c.lon);
      return !isNaN(lat) && !isNaN(lon) && lat !== 0 && lon !== 0;
    });
    dbg(`Cafes parsed — ${parsed.length} total, ${data.length} with coordinates`, data.length > 0);

    try {
      localStorage.setItem(CAFES_CACHE_KEY, JSON.stringify({ timestamp: Date.now(), data }));
    } catch(e) { /* storage full — non-fatal */ }

    return data;
  } catch(e) {
    dbg(`Cafes fetch failed: ${e.message}`, false);
    return []; // non-fatal — app works without cafes
  }
}

function clearCache() {
  localStorage.removeItem(CACHE_KEY);
  localStorage.removeItem(CAFES_CACHE_KEY);
  location.reload();
}

function showCacheAge(timestamp) {
  const el = document.getElementById('cacheAge');
  if (!el) return;
  const mins = Math.floor((Date.now() - timestamp) / 60000);
  el.textContent = mins < 1 ? 'Data: just refreshed' : `Data: ${mins} min${mins > 1 ? 's' : ''} ago`;
}

function parseCSV(csv, columnMap) {
  const colMap = columnMap || CONFIG.COLUMN_MAP;
  const lines = csv.trim().split('\n');
  const rawHeaders = lines[0].split(',').map(h => h.replace(/^"|"$/g, '').trim());

  // Normalise headers using column map (case-insensitive lookup)
  const headers = rawHeaders.map(h => {
    const key = h.toLowerCase();
    return colMap[key] || h; // mapped name, or original if not in map
  });

  return lines.slice(1).map(line => {
    const vals = smartSplit(line);
    const obj = {};
    headers.forEach((h, i) => {
      if (!h) return; // skip empty column headers
      let v = (vals[i] || '').replace(/^"|"$/g, '').trim();
      const vl = v.toLowerCase();
      if (vl === 'true' || vl === 'yes' || v === '1') v = true;
      else if (vl === 'false' || vl === 'no' || v === '0') v = false;
      // blank stays as '' — handled in rideable filter (blank = show)
      else if (!isNaN(v) && v !== '') v = parseFloat(v);
      obj[h] = v;
    });
    // Normalise busway_segment: YES/yes → true, n/no/blank → false
    if ('busway_segment' in obj) {
      const bv = String(obj.busway_segment).toLowerCase().trim();
      obj.busway_segment = (bv === 'yes' || bv === 'true' || bv === '1');
    }
    // Convert decimal-hours Time field to "X h YY min" string
    if (obj.estimated_time_raw !== undefined && obj.estimated_time_raw !== '') {
      const dh = parseFloat(obj.estimated_time_raw);
      if (!isNaN(dh)) {
        const h = Math.floor(dh);
        const m = Math.round((dh - h) * 60);
        obj.estimated_time = m > 0 ? `${h} h ${m} min` : `${h} h`;
      }
    }
    return obj;
  });
}

function smartSplit(line) {
  const result = []; let cur = ''; let inQ = false;
  for (let i = 0; i < line.length; i++) {
    const c = line[i];
    if (c === '"') { inQ = !inQ; }
    else if (c === ',' && !inQ) { result.push(cur); cur = ''; }
    else { cur += c; }
  }
  result.push(cur);
  return result;
}

/* ════════════════════════════════════════════════════════════════════
   FILTERING & SORTING
   ════════════════════════════════════════════════════════════════════ */
function applyFilters() {
  // DEBUG: log first route's raw values so we can see what fields look like
  if (allRoutes.length > 0) {
    const r0 = allRoutes[0];
    dbg(`First route: "${r0.route_name}" | type:"${r0.type}" | dir:"${r0.direction}" | dist:${r0.distance_miles}`);
    const dirVals = [...new Set(allRoutes.map(r => String(r.direction || '')))];
    dbg(`All direction values in data: ${dirVals.join(', ')}`);
  }

  filteredRoutes = allRoutes.filter(r => {
    // type — skip check if sheet has no type column (undefined = show all)
    if (state.type !== 'all' && r.type && r.type !== state.type) return false;

    // distance
    const d = parseFloat(r.distance_miles) || 0;
    if (d < state.distMin || d > state.distMax) return false;

    // ascent
    const a = parseFloat(r.ascent_metres) || 0;
    if (a < state.ascentMin || a > state.ascentMax) return false;

    // direction — normalise before matching, blank = pass through
    const dir = normaliseDir(r.direction);
    if (dir && !state.directions.has(dir)) return false;

    // café display is handled by mapDisplay toggle in refreshMasterMap (separate Cafes dataset)

    // busway
    if (state.excludeBusway && r.busway_segment === true) return false;

    return true;
  });

  dbg(`After filters: ${filteredRoutes.length} of ${allRoutes.length} routes visible`);
  refreshMasterMap(); // keep master map in sync with filters

  filteredRoutes.sort((a, b) => {
    if (state.sort === 'fmr_score')  return (b.fmrScore||0) - (a.fmrScore||0);
    if (state.sort === 'name')       return safe(a.route_name).localeCompare(safe(b.route_name));
    if (state.sort === 'dist_asc')   return (a.distance_miles||0) - (b.distance_miles||0);
    if (state.sort === 'dist_desc')  return (b.distance_miles||0) - (a.distance_miles||0);
    if (state.sort === 'ascent')     return (a.ascent_metres||0) - (b.ascent_metres||0);
    if (state.sort === 'last_ridden') return (b.last_ridden||'').localeCompare(a.last_ridden||'');
    return 0;
  });

  renderCards();
  updateCounts();
}

/* ════════════════════════════════════════════════════════════════════
   HELPERS
   ════════════════════════════════════════════════════════════════════ */
function slugify(name) {
  return name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
}

function distBadgeClass(mi) {
  if (mi < 25) return 'badge-dist-green';
  if (mi <= 40) return 'badge-dist-amber';
  return 'badge-dist-red';
}

function dirBadgeClass(dir) {
  return `badge-dir-${dir}`;
}

function hasRoadwork(notes) {
  return notes && /pothole|roadworks/i.test(notes);
}

function escHtml(s) {
  if (s === null || s === undefined || s === false) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// safe(): always returns a trimmed string, never undefined/null/number issues
function safe(v) {
  if (v === null || v === undefined || v === false || v === true) return '';
  return String(v).trim();
}

// safeNum(): returns a number or 0
function safeNum(v) {
  const n = parseFloat(v);
  return isNaN(n) ? 0 : n;
}

// normaliseDir(): uppercase + trim, maps compound like "s/sw" -> "S"
function normaliseDir(d) {
  const s = safe(d).toUpperCase().replace(/\s/g,'');
  // Handle compound directions like S/SW, N/NE — take the first part
  if (s.includes('/')) return s.split('/')[0];
  return s;
}

/* ════════════════════════════════════════════════════════════════════
   WEATHER RENDERING
   ════════════════════════════════════════════════════════════════════ */
function renderWeatherStrip(weather) {
  const strip = document.getElementById('weatherStrip');
  if (!strip) return;

  if (!weather || !weather.daily || weather.daily.length === 0) {
    strip.innerHTML = '<div class="weather-loading">Weather unavailable</div>';
    return;
  }

  const rideDay = CONFIG.DEFAULT_RIDE_DAY.charAt(0).toUpperCase() + CONFIG.DEFAULT_RIDE_DAY.slice(1);

  strip.innerHTML = weather.daily.map(day => {
    const isSunday = day.dayName === rideDay;
    const windRotation = day.windDir; // degrees clockwise from N (direction wind is FROM)
    return `<div class="weather-day${isSunday ? ' sunday-highlight' : ''}" title="${escHtml(day.desc)}">
      <div class="weather-day-name">${isSunday ? '&#9733; ' : ''}${escHtml(day.dayName.slice(0, 3))}</div>
      <div class="weather-day-icon">${day.icon}</div>
      <div class="weather-day-temp">${day.tempMax}° <span>${day.tempMin}°</span></div>
      <div class="weather-day-wind">
        <span class="wind-arrow" style="transform:rotate(${windRotation}deg)">↓</span>
        ${escHtml(day.windDirLabel)} ${day.windSpeed}
      </div>
      <div class="weather-day-rain">${day.rainProb > 0 ? '💧 ' + day.rainProb + '%' : ''}</div>
    </div>`;
  }).join('');
}

/* ════════════════════════════════════════════════════════════════════
   RIDE PLANNER — Scoring & Rendering
   ════════════════════════════════════════════════════════════════════ */
const DIR_TO_BEARING = { N:0, NE:45, E:90, SE:135, S:180, SW:225, W:270, NW:315 };

function windAlignmentScore(routeDir, sundayWeather) {
  if (!sundayWeather) return 0;
  const routeBearing = DIR_TO_BEARING[normaliseDir(routeDir)] ?? 180;
  const windFrom = sundayWeather.windDir; // degrees wind is coming FROM
  // Tailwind home = outbound direction matches where wind comes from
  // (ride INTO wind outbound, wind pushes you home on return)
  let angleDiff = Math.abs(routeBearing - windFrom);
  if (angleDiff > 180) angleDiff = 360 - angleDiff;
  return Math.cos(angleDiff * Math.PI / 180); // 1.0 = perfect tailwind home, -1.0 = headwind home
}

function windLabel(score) {
  if (score > 0.7)  return { text: 'Tailwind home',     cls: 'pick-wind-tail' };
  if (score > 0.25) return { text: 'Mostly favourable', cls: 'pick-wind-favour' };
  if (score > -0.25) return { text: 'Crosswind',        cls: 'pick-wind-cross' };
  return                     { text: 'Headwind home',    cls: 'pick-wind-head' };
}

function scoreSundayRoutes(routes, weather, targetDist) {
  if (!weather || !weather.sunday) return routes.slice(0, 3);
  const sunday = weather.sunday;

  return routes.map(route => {
    const dist = safeNum(route.distance_miles);
    const dir = normaliseDir(route.direction);

    // Wind alignment (45% weight)
    const ws = windAlignmentScore(dir, sunday);

    // Distance match — gaussian around target (35% weight)
    const distDiff = Math.abs(dist - targetDist);
    const distScore = Math.max(0, 1 - distDiff / 40);

    // Café bonus (10% weight)
    const hasCafe = !!(route.cafe_name || '').trim();
    const cafeScore = hasCafe ? 1 : 0;

    // Recency — prefer routes not recently ridden (10% weight)
    const lr = safe(route.last_ridden).toLowerCase().trim();
    const recencyScore = lr === '' ? 0.8 : 0.5; // unridden gets slight boost

    const total = (ws * 0.45) + (distScore * 0.35) + (cafeScore * 0.10) + (recencyScore * 0.10);
    const matchPct = Math.round(Math.max(0, Math.min(100, (total + 1) / 2 * 100)));
    const wl = windLabel(ws);

    return { ...route, matchPct, windScore: ws, windLabelText: wl.text, windLabelCls: wl.cls };
  }).sort((a, b) => b.matchPct - a.matchPct);
}

function formatDateNice(dateStr) {
  try {
    const d = new Date(dateStr + 'T12:00:00');
    return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
  } catch(e) { return dateStr; }
}

function buildWindCompassSVG(windDir) {
  // Arrow points in the direction wind is blowing TO (windDir + 180)
  const rotation = windDir; // arrow shows where wind comes FROM (pointing down = from north)
  return `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
    <circle cx="50" cy="50" r="46" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="2"/>
    <circle cx="50" cy="50" r="46" fill="none" stroke="rgba(44,188,179,0.3)" stroke-width="2" stroke-dasharray="8 4"/>
    <text x="50" y="14" fill="rgba(255,255,255,0.3)" font-size="8" text-anchor="middle" font-weight="700">N</text>
    <text x="50" y="96" fill="rgba(255,255,255,0.3)" font-size="8" text-anchor="middle" font-weight="700">S</text>
    <text x="8" y="54" fill="rgba(255,255,255,0.3)" font-size="8" text-anchor="middle" font-weight="700">W</text>
    <text x="92" y="54" fill="rgba(255,255,255,0.3)" font-size="8" text-anchor="middle" font-weight="700">E</text>
    <g transform="rotate(${rotation} 50 50)">
      <line x1="50" y1="18" x2="50" y2="70" stroke="#2CBCB3" stroke-width="3" stroke-linecap="round"/>
      <polygon points="50,16 44,28 56,28" fill="#2CBCB3"/>
    </g>
  </svg>`;
}

function renderRidePlanner(weather, routes) {
  const heading = document.getElementById('plannerHeading');
  const advice = document.getElementById('plannerAdvice');
  const picksContainer = document.getElementById('plannerPicks');
  const weatherCard = document.getElementById('plannerWeatherCard');
  const plannerDistSlider = document.getElementById('plannerDist');

  if (!weather || !weather.sunday) {
    if (advice) advice.textContent = 'Weather data unavailable — showing routes by distance match only.';
    if (weatherCard) weatherCard.innerHTML = '<div class="planner-no-weather">Weather unavailable</div>';
    // Still show top picks by distance
    const targetDist = state.targetDistance || 40;
    const sorted = routes.slice().sort((a, b) => {
      return Math.abs(safeNum(a.distance_miles) - targetDist) - Math.abs(safeNum(b.distance_miles) - targetDist);
    }).slice(0, 3);
    renderPickCards(sorted, picksContainer);
    return;
  }

  const sunday = weather.sunday;

  // Update heading
  if (heading) heading.textContent = `This ${sunday.dayName}'s Ride`;

  // Wind direction advice
  const windFromLabel = sunday.windDirLabel;
  // The optimal outbound direction is INTO the wind (so you have tailwind home)
  const optimalOutbound = degreesToCompass(sunday.windDir); // ride INTO wind = wind direction
  const optimalReturn = degreesToCompass((sunday.windDir + 180) % 360);
  if (advice) {
    advice.innerHTML = `Wind from the <strong>${escHtml(windFromLabel)}</strong> at <strong>${sunday.windSpeed} mph</strong> — `
      + `head <strong>${escHtml(optimalOutbound)}</strong> outbound for a tailwind home.`;
  }

  // Weather card
  if (weatherCard) {
    weatherCard.innerHTML = `
      <div class="planner-weather-day">${escHtml(sunday.dayName)}</div>
      <div class="planner-weather-date">${formatDateNice(sunday.date)}</div>
      <div class="planner-weather-icon">${sunday.icon}</div>
      <div class="planner-weather-desc">${escHtml(sunday.desc)}</div>
      <div class="planner-weather-stats">
        <div>
          <div class="planner-weather-stat-val">${sunday.tempMax}°<span style="font-size:0.7rem;color:rgba(255,255,255,0.4)">/${sunday.tempMin}°</span></div>
          <div class="planner-weather-stat-label">Temperature</div>
        </div>
        <div>
          <div class="planner-weather-stat-val">${sunday.windSpeed}<span style="font-size:0.65rem;color:rgba(255,255,255,0.4)"> mph</span></div>
          <div class="planner-weather-stat-label">Wind ${escHtml(windFromLabel)}</div>
        </div>
        <div>
          <div class="planner-weather-stat-val">${sunday.rainProb}<span style="font-size:0.65rem;color:rgba(255,255,255,0.4)">%</span></div>
          <div class="planner-weather-stat-label">Rain chance</div>
        </div>
        <div>
          <div class="planner-weather-stat-val" style="font-size:0.85rem">${escHtml(sunday.desc)}</div>
          <div class="planner-weather-stat-label">Outlook</div>
        </div>
      </div>
      <div class="wind-compass-wrap" title="Wind from ${escHtml(windFromLabel)}">
        ${buildWindCompassSVG(sunday.windDir)}
      </div>
    `;
  }

  // Score and render all picks (sorted by match)
  const targetDist = state.targetDistance || 40;
  const scored = scoreSundayRoutes(routes, weather, targetDist);
  renderPickCards(scored, picksContainer);

  // Bind slider events
  if (plannerDistSlider && !plannerDistSlider._bound) {
    plannerDistSlider._bound = true;
    plannerDistSlider.addEventListener('input', function() {
      state.targetDistance = parseInt(this.value, 10);
      const valEl = document.getElementById('plannerDistVal');
      if (valEl) valEl.textContent = state.targetDistance + ' mi';
      const scored2 = scoreSundayRoutes(allRoutes, weatherData, state.targetDistance);
      renderPickCards(scored2, document.getElementById('plannerPicks'));
    });
  }
}

function renderPickCards(picks, container) {
  if (!container) return;
  if (!picks || picks.length === 0) {
    container.innerHTML = '<div class="planner-no-weather">No routes match your criteria</div>';
    return;
  }

  container.innerHTML = picks.map(route => {
    const slug = slugify(route.route_name);
    const dist = safeNum(route.distance_miles);
    const dir = normaliseDir(route.direction);
    const cafe = safe(route.cafe_name);
    const matchPct = route.matchPct || 0;
    const windCls = route.windLabelCls || 'pick-wind-cross';
    const windText = route.windLabelText || 'Unknown';

    return `<div class="pick-card" onclick="window.scrollToCard('${slug}')">
      <div class="pick-card-match">${matchPct}% match</div>
      <div class="pick-card-name">${escHtml(safe(route.route_name))}</div>
      <div class="pick-card-meta">
        <span>${dist} mi</span>
        <span>${escHtml(dir)}</span>
        <span>${escHtml(safe(route.type))}</span>
      </div>
      <div class="pick-card-wind ${windCls}">${escHtml(windText)}</div>
      ${cafe ? `<div class="pick-card-cafe">☕ ${escHtml(cafe)}</div>` : ''}
    </div>`;
  }).join('');
}

/* ════════════════════════════════════════════════════════════════════
   FIND MY RIDE — Smart Scoring Engine
   ════════════════════════════════════════════════════════════════════ */
function initFindMyRide() {
  const toggle = document.getElementById('findRideToggle');
  const panel = document.getElementById('findMyRide');
  const distSlider = document.getElementById('fmrDist');
  const distVal = document.getElementById('fmrDistVal');
  const timeSlider = document.getElementById('fmrTime');
  const timeVal = document.getElementById('fmrTimeVal');
  const searchBtn = document.getElementById('fmrSearch');
  const resetBtn = document.getElementById('fmrReset');
  const resultMsg = document.getElementById('fmrResultMsg');

  if (!toggle || !panel) return;

  // Toggle open/close
  toggle.addEventListener('click', () => {
    panel.classList.toggle('open');
    toggle.setAttribute('aria-expanded', panel.classList.contains('open'));
  });

  // Slider updates
  distSlider.addEventListener('input', () => {
    distVal.textContent = distSlider.value + ' mi';
  });
  timeSlider.addEventListener('input', () => {
    const v = parseFloat(timeSlider.value);
    timeVal.textContent = v === 1 ? '1 hr' : v % 1 === 0 ? v + ' hrs' : v + ' hrs';
  });

  // Option button groups
  document.querySelectorAll('.find-ride-options').forEach(group => {
    group.querySelectorAll('.find-ride-opt').forEach(btn => {
      btn.addEventListener('click', () => {
        group.querySelectorAll('.find-ride-opt').forEach(b => {
          b.classList.remove('active');
          b.setAttribute('aria-checked', 'false');
        });
        btn.classList.add('active');
        btn.setAttribute('aria-checked', 'true');
      });
    });
  });

  // Search action
  searchBtn.addEventListener('click', () => {
    const prefs = getFindMyRidePrefs();
    applyFindMyRide(prefs);
  });

  // Reset
  resetBtn.addEventListener('click', () => {
    distSlider.value = 40;
    distVal.textContent = '40 mi';
    timeSlider.value = 3;
    timeVal.textContent = '3 hrs';
    // Reset all option groups to first option
    document.querySelectorAll('.find-ride-options').forEach(group => {
      group.querySelectorAll('.find-ride-opt').forEach((btn, i) => {
        btn.classList.toggle('active', i === 0 || (group.id === 'fmrDifficulty' && btn.dataset.val === 'moderate'));
        btn.setAttribute('aria-checked', btn.classList.contains('active'));
      });
    });
    // Reset difficulty specifically to "moderate"
    const diffGroup = document.getElementById('fmrDifficulty');
    if (diffGroup) {
      diffGroup.querySelectorAll('.find-ride-opt').forEach(b => {
        b.classList.toggle('active', b.dataset.val === 'moderate');
        b.setAttribute('aria-checked', b.dataset.val === 'moderate' ? 'true' : 'false');
      });
    }
    resultMsg.textContent = '';
    // Re-sort to default
    state.sort = 'name';
    const sortSel = document.getElementById('sortSelect');
    if (sortSel) sortSel.value = 'name';
    applyFilters();
  });
}

function getFindMyRidePrefs() {
  return {
    distance: parseInt(document.getElementById('fmrDist').value) || 40,
    timeHours: parseFloat(document.getElementById('fmrTime').value) || 3,
    cafe: getActiveVal('fmrCafe') || 'any',
    difficulty: getActiveVal('fmrDifficulty') || 'moderate',
    type: getActiveVal('fmrType') || 'any',
    busway: getActiveVal('fmrBusway') || 'any',
  };
}

function getActiveVal(groupId) {
  const group = document.getElementById(groupId);
  if (!group) return null;
  const active = group.querySelector('.find-ride-opt.active');
  return active ? active.dataset.val : null;
}

function scoreRouteForPrefs(route, prefs) {
  const dist = parseFloat(route.distance_miles) || 0;
  const ascent = parseFloat(route.ascent_metres) || 0;
  const hasCafe = !!(route.cafe_name || '').trim();
  const routeType = (safe(route.type) || 'Road').trim();
  const isBusway = (route.busway_segment === true || route.busway_segment === 'TRUE');
  const lr = safe(route.last_ridden).toLowerCase().trim();

  let score = 0;

  // 1. Distance fit (25% weight) — gaussian around target
  const distDiff = Math.abs(dist - prefs.distance);
  const distScore = Math.exp(-(distDiff * distDiff) / (2 * 15 * 15)); // σ = 15
  score += 0.25 * distScore;

  // 2. Wind alignment (25% weight, if weather available)
  let windScore = 0.5; // neutral default
  if (weatherData && weatherData.sunday) {
    const dir = normaliseDir(route.direction);
    const ws = windAlignmentScore(dir, weatherData.sunday);
    windScore = (ws + 1) / 2; // normalise from [-1,1] to [0,1]
  }
  score += 0.25 * windScore;

  // 3. Café match (15% weight)
  if (prefs.cafe === 'yes') {
    score += 0.15 * (hasCafe ? 1 : 0);
  } else if (prefs.cafe === 'no') {
    score += 0.15 * (hasCafe ? 0.3 : 1); // slight penalty for café routes
  } else {
    score += 0.15 * 0.8; // "any" — mild positive
  }

  // 4. Difficulty/ascent match (15% weight)
  let ascentTarget, ascentSigma;
  if (prefs.difficulty === 'easy') {
    ascentTarget = 100; ascentSigma = 80;
  } else if (prefs.difficulty === 'hard') {
    ascentTarget = 500; ascentSigma = 200;
  } else {
    ascentTarget = 250; ascentSigma = 120;
  }
  const ascentDiff = Math.abs(ascent - ascentTarget);
  const ascentScore = Math.exp(-(ascentDiff * ascentDiff) / (2 * ascentSigma * ascentSigma));
  score += 0.15 * ascentScore;

  // 5. Time fit (10% weight) — estimate ride time from distance at ~15mph avg
  const estHours = dist / 15;
  const timeDiff = Math.abs(estHours - prefs.timeHours);
  const timeScore = Math.exp(-(timeDiff * timeDiff) / (2 * 1.2 * 1.2));
  score += 0.10 * timeScore;

  // 6. Recency — prefer unridden routes (10% weight)
  const recencyScore = lr === '' ? 0.9 : 0.4;
  score += 0.10 * recencyScore;

  // Type filter (hard filter, not scored)
  if (prefs.type !== 'any' && routeType.toLowerCase() !== prefs.type.toLowerCase()) {
    score *= 0.15; // heavy penalty but don't zero out entirely
  }

  // Busway filter
  if (prefs.busway === 'avoid' && isBusway) {
    score *= 0.3;
  }

  return Math.round(Math.max(0, Math.min(100, score * 100)));
}

function applyFindMyRide(prefs) {
  // Score all routes — attach fmrScore to each route object
  allRoutes.forEach(route => {
    route.fmrScore = scoreRouteForPrefs(route, prefs);
  });

  // Override sort to show by match score
  state.sort = 'fmr_score';
  const sortSel = document.getElementById('sortSelect');
  if (sortSel) {
    // Add the option if it doesn't exist
    if (!sortSel.querySelector('option[value="fmr_score"]')) {
      const opt = document.createElement('option');
      opt.value = 'fmr_score';
      opt.textContent = 'Best match';
      sortSel.insertBefore(opt, sortSel.firstChild);
    }
    sortSel.value = 'fmr_score';
  }

  // Re-run filters (which will now sort by fmr_score)
  applyFilters();

  // After filters run, update match scores on visible cards
  filteredRoutes.forEach(route => {
    const slug = slugify(route.route_name);
    const card = document.getElementById('route-' + slug);
    if (card) {
      const matchEl = card.querySelector('.card-match-score');
      if (matchEl) {
        matchEl.innerHTML = `<span class="match-num">${escHtml(String(route.fmrScore))}%</span> match`;
      }
    }
  });

  const msg = document.getElementById('fmrResultMsg');
  if (msg) {
    const topScore = filteredRoutes[0] ? filteredRoutes[0].fmrScore : 0;
    msg.textContent = `${filteredRoutes.length} routes scored — best match ${topScore}%`;
  }

  // Scroll to results
  const listTab = document.querySelector('.view-tabs');
  if (listTab) listTab.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

/* ════════════════════════════════════════════════════════════════════
   ROUTE COMPARISON
   ════════════════════════════════════════════════════════════════════ */
const compareSet = new Set(); // slugs of selected routes (max 3)
const COMPARE_COLORS = ['#2CBCB3', '#f59e0b', '#8b5cf6']; // teal, amber, purple

function toggleCompare(slug) {
  if (compareSet.has(slug)) {
    compareSet.delete(slug);
  } else {
    if (compareSet.size >= 3) return; // max 3
    compareSet.add(slug);
  }
  updateCompareUI();
}
window.toggleCompare = toggleCompare;

function updateCompareUI() {
  // Update toggle buttons on cards
  document.querySelectorAll('.compare-toggle').forEach(btn => {
    const slug = btn.id.replace('cmp-', '');
    const active = compareSet.has(slug);
    btn.classList.toggle('active', active);
    const check = btn.querySelector('.compare-check');
    if (check) check.textContent = active ? '✓' : '';
  });

  // Update floating bar
  const bar = document.getElementById('compareBar');
  const chips = document.getElementById('compareChips');
  const btn = document.getElementById('compareBtn');

  if (compareSet.size > 0) {
    bar.classList.add('visible');
    chips.innerHTML = Array.from(compareSet).map(slug => {
      const route = allRoutes.find(r => slugify(r.route_name) === slug);
      const name = route ? escHtml(safe(route.route_name)) : slug;
      return `<span class="compare-chip">
        ${name}
        <button class="compare-chip-remove" onclick="toggleCompare('${slug}')" aria-label="Remove ${name}">✕</button>
      </span>`;
    }).join('');
    btn.disabled = compareSet.size < 2;
  } else {
    bar.classList.remove('visible');
  }
}

function initCompare() {
  const compareBtn = document.getElementById('compareBtn');
  const closeBtn = document.getElementById('compareClose');
  const overlay = document.getElementById('compareOverlay');

  if (compareBtn) {
    compareBtn.addEventListener('click', () => {
      if (compareSet.size >= 2) showComparison();
    });
  }
  if (closeBtn) {
    closeBtn.addEventListener('click', closeComparison);
  }
  if (overlay) {
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) closeComparison();
    });
  }
}

function showComparison() {
  const slugs = Array.from(compareSet);
  const routes = slugs.map(slug => allRoutes.find(r => slugify(r.route_name) === slug)).filter(Boolean);
  if (routes.length < 2) return;

  const body = document.getElementById('compareBody');
  const overlay = document.getElementById('compareOverlay');

  // Build comparison table
  const metrics = [
    { label: 'Route', key: 'name' },
    { label: 'Distance', key: 'distance', unit: ' mi', best: 'closest40' },
    { label: 'Ascent', key: 'ascent', unit: ' m' },
    { label: 'Type', key: 'type' },
    { label: 'Direction', key: 'direction' },
    { label: 'Ride time', key: 'time' },
    { label: 'With coffee', key: 'coffee_time' },
    { label: 'Café', key: 'cafe' },
    { label: 'Wind', key: 'wind' },
    { label: 'Match', key: 'match' },
    { label: 'Busway', key: 'busway' },
    { label: 'Last ridden', key: 'last_ridden' },
  ];

  const getCellVal = (route, key) => {
    switch (key) {
      case 'name': return escHtml(safe(route.route_name));
      case 'distance': return safeNum(route.distance_miles) || '—';
      case 'ascent': return safeNum(route.ascent_metres) || '—';
      case 'type': return escHtml(safe(route.type) || '—');
      case 'direction': return escHtml(normaliseDir(route.direction) || '—');
      case 'time': return escHtml(safe(route.estimated_time) || '—');
      case 'coffee_time': return escHtml(safe(route.time_with_coffee) || '—');
      case 'cafe': return route.cafe_name ? escHtml(safe(route.cafe_name)) : '—';
      case 'wind': {
        if (!weatherData || !weatherData.sunday) return '—';
        const ws = windAlignmentScore(normaliseDir(route.direction), weatherData.sunday);
        const wl = windLabel(ws);
        return `<span class="compare-wind-cell ${wl.cls.replace('pick-', 'card-wind-badge ')}">${escHtml(wl.text)}</span>`;
      }
      case 'match': {
        if (route.fmrScore !== undefined) return route.fmrScore + '%';
        if (!weatherData || !weatherData.sunday) return '—';
        const dir = normaliseDir(route.direction);
        const ws = windAlignmentScore(dir, weatherData.sunday);
        const dist = safeNum(route.distance_miles);
        const targetDist = state.targetDistance || CONFIG.TARGET_DISTANCE || 40;
        const distDiff = Math.abs(dist - targetDist);
        const distScore = Math.max(0, 1 - distDiff / 40);
        const hasCafe = !!(route.cafe_name || '').trim();
        const lr = safe(route.last_ridden).toLowerCase().trim();
        const total = (ws * 0.45) + (distScore * 0.35) + ((hasCafe ? 1 : 0) * 0.10) + ((lr === '' ? 0.8 : 0.5) * 0.10);
        return Math.round(Math.max(0, Math.min(100, (total + 1) / 2 * 100))) + '%';
      }
      case 'busway': return (route.busway_segment === true || route.busway_segment === 'TRUE') ? 'Yes' : 'No';
      case 'last_ridden': return escHtml(safe(route.last_ridden) || 'Never');
      default: return '—';
    }
  };

  let tableHtml = '<table class="compare-table"><tbody>';

  metrics.forEach(metric => {
    tableHtml += '<tr>';
    tableHtml += `<th>${escHtml(metric.label)}</th>`;
    routes.forEach((route, i) => {
      const val = getCellVal(route, metric.key);
      const unit = (metric.unit && val !== '—') ? metric.unit : '';
      const cls = metric.key === 'name' ? ' class="compare-route-name"' : '';
      tableHtml += `<td${cls}>${val}${unit}</td>`;
    });
    tableHtml += '</tr>';
  });

  tableHtml += '</tbody></table>';

  // Add elevation comparison chart area
  tableHtml += `
    <div class="compare-elev-wrap">
      <div class="compare-elev-title">Elevation Profiles (overlaid)</div>
      <div class="compare-elev-chart">
        <canvas id="compareElevChart"></canvas>
      </div>
    </div>`;

  body.innerHTML = tableHtml;
  overlay.classList.add('visible');
  document.body.style.overflow = 'hidden';

  // Load elevation data for comparison chart
  loadCompareElevations(routes);
}

function loadCompareElevations(routes) {
  const canvas = document.getElementById('compareElevChart');
  if (!canvas || typeof Chart === 'undefined') return;

  const datasets = [];
  let loaded = 0;

  routes.forEach((route, i) => {
    if (!route.gpx_url) {
      loaded++;
      if (loaded === routes.length) renderCompareChart(canvas, datasets);
      return;
    }

    fetch(route.gpx_url)
      .then(r => r.text())
      .then(gpxText => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(gpxText, 'text/xml');
        const trkpts = doc.querySelectorAll('trkpt');
        const elevations = [];
        trkpts.forEach(pt => {
          const ele = pt.querySelector('ele');
          if (ele) elevations.push(parseFloat(ele.textContent));
        });

        if (elevations.length > 0) {
          // Downsample to 100 points for smooth chart
          const sampled = downsample(elevations, 100);
          datasets.push({
            label: safe(route.route_name),
            data: sampled,
            borderColor: COMPARE_COLORS[i % COMPARE_COLORS.length],
            backgroundColor: COMPARE_COLORS[i % COMPARE_COLORS.length] + '20',
            fill: true,
            tension: 0.3,
            pointRadius: 0,
            borderWidth: 2,
          });
        }
      })
      .catch(() => {})
      .finally(() => {
        loaded++;
        if (loaded === routes.length) renderCompareChart(canvas, datasets);
      });
  });
}

function downsample(arr, targetLen) {
  if (arr.length <= targetLen) return arr;
  const step = arr.length / targetLen;
  const result = [];
  for (let i = 0; i < targetLen; i++) {
    const idx = Math.floor(i * step);
    result.push(arr[idx]);
  }
  return result;
}

function renderCompareChart(canvas, datasets) {
  if (datasets.length === 0) {
    canvas.parentElement.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--grey-300);font-size:0.82rem">No GPX elevation data available for these routes</div>';
    return;
  }

  const labels = datasets[0].data.map((_, i) => Math.round(i / datasets[0].data.length * 100) + '%');

  new Chart(canvas, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { intersect: false, mode: 'index' },
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: { usePointStyle: true, padding: 12, font: { size: 11, family: "'Inter', sans-serif" } }
        },
        tooltip: {
          callbacks: {
            label: (ctx) => `${ctx.dataset.label}: ${Math.round(ctx.parsed.y)}m`
          }
        }
      },
      scales: {
        x: {
          display: true,
          title: { display: true, text: '% of route', font: { size: 10 } },
          ticks: { maxTicksToShow: 5, font: { size: 9 } },
          grid: { display: false }
        },
        y: {
          display: true,
          title: { display: true, text: 'Elevation (m)', font: { size: 10 } },
          ticks: { font: { size: 9 } },
          grid: { color: 'rgba(0,0,0,0.05)' }
        }
      }
    }
  });
}

function closeComparison() {
  document.getElementById('compareOverlay').classList.remove('visible');
  document.body.style.overflow = '';
}

/* ════════════════════════════════════════════════════════════════════
   RENDER
   ════════════════════════════════════════════════════════════════════ */
function renderCards() {
  const grid = document.getElementById('routesGrid');

  if (filteredRoutes.length === 0) {
    grid.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">🚴</div>
        <h3>No routes match your filters</h3>
        <p>Try widening your distance or ascent range, or deselecting some directions.</p>
        <button class="empty-reset" onclick="resetFilters()">↺ Reset all filters</button>
      </div>`;
    return;
  }

  grid.innerHTML = filteredRoutes.map((route, idx) => buildCard(route, idx)).join('');

  // Restore open maps
  filteredRoutes.forEach((route, idx) => {
    const slug = slugify(route.route_name);
    if (openMaps[slug]) {
      setTimeout(() => openMapForCard(route, idx, slug), 50);
    }
  });

  // Hash scroll
  checkHash();
}

function buildCard(route, idx) {
  const slug = slugify(route.route_name);
  const dist = parseFloat(route.distance_miles) || 0;
  const ascent = parseFloat(route.ascent_metres) || 0;
  const gpxDisabled = !route.gpx_url ? 'disabled data-tip="GPX not yet available"' : '';
  const garminDisabled = !route.garmin_link ? 'style="display:none"' : '';

  // Weather-aware row
  let weatherRowHtml = '';
  if (weatherData && weatherData.sunday) {
    const sun = weatherData.sunday;
    const dir = normaliseDir(route.direction);
    const ws = windAlignmentScore(dir, sun);
    const wl = windLabel(ws);

    // Calculate match score (same weights as scoreSundayRoutes)
    const targetDist = state.targetDistance || CONFIG.TARGET_DISTANCE || 40;
    const distDiff = Math.abs(dist - targetDist);
    const distScore = Math.max(0, 1 - distDiff / 40);
    const hasCafe = !!(route.cafe_name || '').trim();
    const cafeScore = hasCafe ? 1 : 0;
    const lr = safe(route.last_ridden).toLowerCase().trim();
    const recencyScore = lr === '' ? 0.8 : 0.5;
    const total = (ws * 0.45) + (distScore * 0.35) + (cafeScore * 0.10) + (recencyScore * 0.10);
    const matchPct = Math.round(Math.max(0, Math.min(100, (total + 1) / 2 * 100)));

    // Wind direction mini arrow SVG
    const windBlowTo = (sun.windDir + 180) % 360;
    const windArrowSvg = `<svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
      <g transform="rotate(${windBlowTo}, 8, 8)">
        <line x1="8" y1="13" x2="8" y2="3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        <polyline points="5,6 8,3 11,6" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </g>
    </svg>`;

    const windDotHtml = ws > 0.7 ? '🟢' : ws > 0.25 ? '🟡' : ws > -0.25 ? '🟠' : '🔴';

    weatherRowHtml = `
      <div class="card-weather-row">
        <span class="card-weather-icon">${escHtml(sun.icon)}</span>
        <span class="card-weather-temp">${escHtml(String(sun.tempMax))}°C</span>
        <span class="card-weather-wind">
          ${windArrowSvg}
          ${escHtml(sun.windDirLabel)} ${escHtml(String(sun.windSpeed))} mph
        </span>
        <span class="card-wind-badge ${wl.cls}">${windDotHtml} ${escHtml(wl.text)}</span>
        <span class="card-match-score"><span class="match-num">${matchPct}%</span> match</span>
      </div>`;
  }

  const rw = hasRoadwork(safe(route.notes));
  const warningHtml = safe(route.notes) ? `
    <div class="warning-banner ${rw ? 'has-roadwork' : ''}">
      ⚠️ <span>${escHtml(route.notes)}${rw ? '<span class="roadwork-badge">🚧 HAZARD</span>' : ''}</span>
    </div>` : '';

  const cafeHtml = safe(route.cafe_name) ? `
    <div class="cafe-row">
      <span class="cafe-icon">☕</span>
      <div>
        <div class="cafe-name">
          ${route.cafe_maps_url
            ? `<a href="${escHtml(route.cafe_maps_url)}" target="_blank" rel="noopener noreferrer">${escHtml(route.cafe_name)}</a>`
            : escHtml(route.cafe_name)}
        </div>
        ${route.cafe_hours ? `<div class="cafe-hours">${escHtml(route.cafe_hours)}</div>` : ''}
      </div>
    </div>` : '';

  const lastRidden = safe(route.last_ridden)
    ? `<div class="last-ridden">Last ridden: <span>${escHtml(safe(route.last_ridden))}</span></div>`
    : `<div class="last-ridden" style="color:var(--grey-300)">Never ridden</div>`;

  const buswayBadge = (route.busway_segment === true || route.busway_segment === 'TRUE')
    ? `<span class="badge badge-busway">🚌 Busway</span>` : '';

  return `
    <article class="route-card" id="route-${slug}">
      <div class="card-main">
        <div class="card-top">
          <div>
            <div class="route-name">${escHtml(route.route_name)}</div>
            ${route.source ? `<div class="route-source">${escHtml(route.source)}</div>` : ''}
          </div>
          <div class="badges">
            <span class="badge ${distBadgeClass(dist)}">📏 ${dist} mi</span>
            <span class="badge badge-ascent">⛰ ${ascent} m</span>
            ${safe(route.type) ? `<span class="badge badge-type-${safe(route.type).toLowerCase() === 'gravel' ? 'gravel' : 'road'}">${safe(route.type).toLowerCase() === 'gravel' ? '🏕' : '🚴'} ${escHtml(safe(route.type))}</span>` : ''}
            ${normaliseDir(route.direction) ? `<span class="badge ${dirBadgeClass(normaliseDir(route.direction))}">🧭 ${escHtml(normaliseDir(route.direction))}</span>` : ''}
            ${buswayBadge}
          </div>
        </div>

        ${weatherRowHtml}

        <div class="card-meta">
          <div class="meta-item">
            <div class="meta-key">⏱ Ride time</div>
            <div class="meta-val">${escHtml(safe(route.estimated_time) || '—')}</div>
          </div>
          <div class="meta-item">
            <div class="meta-key">☕ inc. coffee</div>
            <div class="meta-val">${escHtml(safe(route.time_with_coffee) || '—')}</div>
          </div>
          <div class="meta-item">
            <div class="meta-key">💨 Speed</div>
            <div class="meta-val mono">${safeNum(route.recommended_speed_mph) || '—'} mph</div>
          </div>
        </div>

        ${cafeHtml}
        ${lastRidden}
        ${warningHtml}

        <div class="card-actions">
          <button class="action-btn btn-map" onclick="toggleMap('${slug}', ${idx})" id="mapBtn-${slug}">
            📍 View on Map
          </button>
          <a class="action-btn btn-gpx tooltip" ${gpxDisabled}
            ${route.gpx_url ? `href="${escHtml(route.gpx_url)}" download` : ''}
            style="${!route.gpx_url ? 'pointer-events:none;opacity:0.5' : ''}">
            ⬇️ Download GPX
          </a>
          ${route.garmin_link ? `<a class="action-btn btn-garmin" href="${escHtml(route.garmin_link)}" target="_blank" rel="noopener noreferrer">🔗 Garmin Connect</a>` : ''}
          <button class="action-btn btn-share" onclick="shareRoute('${slug}')" title="Copy share link">🔗 Share</button>
          <button class="compare-toggle" onclick="toggleCompare('${slug}')" id="cmp-${slug}" title="Add to comparison">
            <span class="compare-check"></span> Compare
          </button>
        </div>
      </div>

      <!-- Map panel (hidden until toggled) -->
      <div class="map-panel" id="mapPanel-${slug}">
        <div class="stats-bar" id="statsBar-${slug}">
          <div class="stats-bar-item">
            <span class="stats-bar-icon">📏</span>
            <div class="stats-bar-val">${dist}</div>
            <div class="stats-bar-key">miles</div>
          </div>
          <div class="stats-bar-item">
            <span class="stats-bar-icon">⛰</span>
            <div class="stats-bar-val">${ascent}</div>
            <div class="stats-bar-key">metres ascent</div>
          </div>
          <div class="stats-bar-item">
            <span class="stats-bar-icon">⏱</span>
            <div class="stats-bar-val">${safe(route.estimated_time).replace(' h ','h ').replace(' min','m') || '—'}</div>
            <div class="stats-bar-key">ride time</div>
          </div>
          <div class="stats-bar-item">
            <span class="stats-bar-icon">☕</span>
            <div class="stats-bar-val">${safe(route.time_with_coffee).replace(' h ','h ').replace(' min','m') || '—'}</div>
            <div class="stats-bar-key">w/ coffee</div>
          </div>
          <div class="stats-bar-item">
            <span class="stats-bar-icon">🧭</span>
            <div class="stats-bar-val">${normaliseDir(route.direction) || '—'}</div>
            <div class="stats-bar-key">direction</div>
          </div>
          <div class="stats-bar-item">
            <span class="stats-bar-icon">💨</span>
            <div class="stats-bar-val">${safeNum(route.recommended_speed_mph) || '—'}</div>
            <div class="stats-bar-key">rec. mph</div>
          </div>
        </div>
        <div class="map-container" id="map-${slug}"></div>
        <div class="elevation-wrap">
          <div class="elevation-label">Elevation Profile</div>
          <div class="elevation-chart-wrap">
            <canvas id="elev-${slug}"></canvas>
          </div>
        </div>
      </div>
    </article>
  `;
}

/* ════════════════════════════════════════════════════════════════════
   MAP LOGIC
   ════════════════════════════════════════════════════════════════════ */
function toggleMap(slug, idx) {
  const panel = document.getElementById(`mapPanel-${slug}`);
  const btn   = document.getElementById(`mapBtn-${slug}`);
  const isOpen = panel.classList.contains('open');

  if (isOpen) {
    panel.classList.remove('open');
    btn.classList.remove('active');
    btn.textContent = '📍 View on Map';
    delete openMaps[slug];
  } else {
    panel.classList.add('open');
    btn.classList.add('active');
    btn.textContent = '🗺 Hide Map';
    openMaps[slug] = true;
    const route = filteredRoutes[idx];
    setTimeout(() => initMap(slug, route), 80);
  }
}

const leafletMaps = {};
const elevCharts = {};

/* ── Shared café helpers (used by master map + card maps) ── */
function buildCafePopupHtml(cafe) {
  const name    = escHtml(safe(cafe.cafe_name));
  const village = escHtml(safe(cafe.village));
  const rating  = cafe.rating ? '⭐'.repeat(Math.min(parseInt(cafe.rating) || 0, 5)) : '';
  const satHrs  = safe(cafe.saturday_hours);
  const sunHrs  = safe(cafe.sunday_hours);
  const hours   = (satHrs || sunHrs)
    ? `<div style="font-size:0.75rem;margin-top:0.3rem">` +
      (satHrs ? `<div>Sat: ${escHtml(satHrs)}</div>` : '') +
      (sunHrs ? `<div>Sun: ${escHtml(sunHrs)}</div>` : '') +
      `</div>` : '';
  const notes   = safe(cafe.notes) ? `<div style="font-size:0.7rem;color:#666;margin-top:0.2rem">${escHtml(cafe.notes)}</div>` : '';
  const website = safe(cafe.website)
    ? `<a href="${escHtml(cafe.website)}" target="_blank" rel="noopener noreferrer" style="display:block;font-size:0.7rem;color:#e8621a;margin-top:0.2rem">Visit website ↗</a>` : '';
  return `
    <div style="min-width:140px">
      <div style="font-weight:700;font-size:0.85rem">🍳 ${name}</div>
      ${village ? `<div style="font-size:0.75rem;color:#555">${village}</div>` : ''}
      ${rating ? `<div style="font-size:0.8rem">${rating}</div>` : ''}
      ${hours}${notes}${website}
    </div>`;
}

function addCafesToMap(map, fontSize) {
  if (!allCafes || allCafes.length === 0) return;
  const bounds = map.getBounds();
  allCafes.forEach(cafe => {
    const lat = parseFloat(cafe.lat);
    const lon = parseFloat(cafe.lon);
    if (isNaN(lat) || isNaN(lon)) return;
    if (!bounds.contains([lat, lon])) return;
    const cafeIcon = L.icon({
      iconUrl: 'images/cafe-icon.png', shadowUrl: '',
      iconSize: [fontSize, fontSize], iconAnchor: [fontSize/2, fontSize],
      popupAnchor: [0, -fontSize], className: 'cafe-marker'
    });
    const name = escHtml(safe(cafe.cafe_name));
    L.marker([lat, lon], { icon: cafeIcon })
      .addTo(map)
      .bindPopup(buildCafePopupHtml(cafe), { maxWidth: 220 })
      .bindTooltip(`🍳 ${name}`, { sticky: true });
  });
}

function initMap(slug, route) {
  if (leafletMaps[slug]) {
    leafletMaps[slug].invalidateSize();
    return;
  }

  const mapEl = document.getElementById(`map-${slug}`);
  if (!mapEl) return;

  const lat = parseFloat(route.start_lat) || SWAVESEY.lat;
  const lon = parseFloat(route.start_lon) || SWAVESEY.lon;

  const map = L.map(mapEl).setView([lat, lon], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors',
    maxZoom: 18,
  }).addTo(map);

  leafletMaps[slug] = map;

  // Start marker
  const startIcon = L.divIcon({
    html: `<div style="background:var(--green);border:3px solid white;border-radius:50%;width:20px;height:20px;box-shadow:0 2px 6px rgba(0,0,0,.3)"></div>`,
    iconSize: [20, 20], iconAnchor: [10, 10], className: ''
  });
  L.marker([lat, lon], { icon: startIcon })
    .addTo(map)
    .bindPopup(`<b>Start:</b> ${escHtml(safe(route.route_name))} — ${safeNum(route.distance_miles)} miles`);

  // GPX track
  if (route.gpx_url) {
    new L.GPX(route.gpx_url, {
      async: true,
      marker_options: { startIconUrl: '', endIconUrl: '', shadowUrl: '', wptIconUrls: { '': '' } },
      polyline_options: { color: '#e8621a', weight: 3.5, opacity: 0.9 }
    }).on('loaded', function(e) {
      map.fitBounds(e.target.getBounds());
      buildElevationChart(slug, e.target);
      // Add café markers once the map settles to the new bounds
      map.once('moveend', function() { addCafesToMap(map, 22); });
      e.target.eachLayer(function(layer) {
        if (layer.setStyle) {
          layer.on('mouseover', function() { this.setStyle({ weight: 5, opacity: 1.0 }); });
          layer.on('mouseout', function() { this.setStyle({ weight: 3.5, opacity: 0.9 }); });
        }
      });
    }).addTo(map);
  } else {
    buildDemoElevationChart(slug, route);
  }

  map.invalidateSize();
}

function buildElevationChart(slug, gpxLayer) {
  const canvas = document.getElementById(`elev-${slug}`);
  if (!canvas) return;
  // GPX layer elevation data
  const data = [];
  gpxLayer.eachLayer(layer => {
    if (layer.getLatLngs) {
      const lls = layer.getLatLngs();
      lls.forEach((ll, i) => { if (ll.alt) data.push(ll.alt); });
    }
  });
  if (data.length === 0) { buildDemoElevationChart(slug); return; }
  createElevChart(slug, data);
}

function buildDemoElevationChart(slug, route) {
  // Generate plausible demo elevation profile
  const base = 10;
  const pts = 30;
  const ascent = parseFloat((route||{}).ascent_metres) || 80;
  const data = Array.from({length: pts}, (_, i) => {
    return base + Math.sin(i / pts * Math.PI * 2) * (ascent / 4) + Math.random() * 8;
  });
  createElevChart(slug, data);
}

function createElevChart(slug, data) {
  if (elevCharts[slug]) elevCharts[slug].destroy();
  const canvas = document.getElementById(`elev-${slug}`);
  if (!canvas) return;

  const labels = data.map((_, i) => '');
  elevCharts[slug] = new Chart(canvas, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        data,
        borderColor: '#e8621a',
        backgroundColor: 'rgba(232,98,26,0.1)',
        borderWidth: 2,
        pointRadius: 0,
        fill: true,
        tension: 0.4,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { display: false },
        y: {
          display: true,
          ticks: { font: { size: 9 }, color: '#8c97a8', maxTicksLimit: 4 },
          grid: { color: '#eef0f4' }
        }
      }
    }
  });
}

/* ════════════════════════════════════════════════════════════════════
   SHARE / HASH
   ════════════════════════════════════════════════════════════════════ */
function shareRoute(slug) {
  const url = `${location.origin}${location.pathname}#${slug}`;
  navigator.clipboard?.writeText(url).then(() => {
    // Visual feedback
    const btn = document.querySelector(`#route-${slug} .btn-share`);
    if (btn) { btn.textContent = '✅ Copied!'; setTimeout(() => { btn.textContent = '🔗 Share'; }, 1800); }
  }).catch(() => {
    window.location.hash = slug;
  });
  window.location.hash = slug;
}

function checkHash() {
  const hash = window.location.hash.replace('#', '');
  if (!hash) return;
  const el = document.getElementById(`route-${hash}`);
  if (el) {
    setTimeout(() => {
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      el.classList.add('pulse');
      setTimeout(() => el.classList.remove('pulse'), 1400);
    }, 200);
  }
}

/* ════════════════════════════════════════════════════════════════════
   FILTER CONTROLS
   ════════════════════════════════════════════════════════════════════ */
function debouncedFilter() {
  clearTimeout(filterTimer);
  filterTimer = setTimeout(applyFilters, 120);
}

function updateCounts() {
  const total = allRoutes.length;
  const shown = filteredRoutes.length;
  document.getElementById('resultCount').textContent = `${shown} of ${total}`;
  document.getElementById('hero-total').textContent = total;
  document.getElementById('hero-road').textContent  = allRoutes.filter(r => safe(r.type).toLowerCase() === 'road').length;
  const mtbEl = document.getElementById('hero-mtb');
  if (mtbEl) mtbEl.textContent = allRoutes.filter(r => safe(r.type).toLowerCase() === 'mtb').length;
  const gravelEl = document.getElementById('hero-gravel');
  if (gravelEl) gravelEl.textContent = allRoutes.filter(r => safe(r.type).toLowerCase() === 'gravel').length;
}

function resetFilters() {
  state.type = 'all';
  state.distMin = 0; state.distMax = 160;
  state.ascentMin = 0; state.ascentMax = 2500;
  state.directions = new Set(['N','NE','E','SE','S','SW','W','NW']);
  state.mapDisplay = 'all';
  state.excludeBusway = false;

  // Reset UI
  document.getElementById('distMin').value = 0;
  document.getElementById('distMax').value = 160;
  document.getElementById('ascentMin').value = 0;
  document.getElementById('ascentMax').value = 2500;
  document.getElementById('distMinVal').textContent = '0 mi';
  document.getElementById('distMaxVal').textContent = '160 mi';
  document.getElementById('ascentMinVal').textContent = '0 m';
  document.getElementById('ascentMaxVal').textContent = '2500 m';
  document.getElementById('buswayToggle').checked = false;
  document.querySelectorAll('#dirChecks input[type=checkbox]').forEach(cb => cb.checked = true);
  document.querySelectorAll('#typeToggle .toggle-btn').forEach(b => b.classList.toggle('active', b.dataset.val === 'all'));
  document.querySelectorAll('#mapDisplayToggle .toggle-btn').forEach(b => b.classList.toggle('active', b.dataset.val === 'all'));

  applyFilters();
}

/* ════════════════════════════════════════════════════════════════════
   INIT
   ════════════════════════════════════════════════════════════════════ */
function initControls() {
  // Type toggle
  document.querySelectorAll('#typeToggle .toggle-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#typeToggle .toggle-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      state.type = btn.dataset.val;
      applyFilters();
    });
  });

  // Range sliders
  ['distMin','distMax','ascentMin','ascentMax'].forEach(id => {
    document.getElementById(id).addEventListener('input', e => {
      const v = e.target.value;
      const labelId = id + 'Val';
      const unit = id.startsWith('dist') ? ' mi' : ' m';
      document.getElementById(labelId).textContent = v + unit;
      state[id] = parseInt(v);
      debouncedFilter();
    });
  });

  // Direction checkboxes
  document.querySelectorAll('#dirChecks input[type=checkbox]').forEach(cb => {
    cb.addEventListener('change', () => {
      state.directions = new Set(
        [...document.querySelectorAll('#dirChecks input:checked')].map(c => c.value)
      );
      debouncedFilter();
    });
  });

  // Map display toggle (Routes / All / Cafés)
  document.querySelectorAll('#mapDisplayToggle .toggle-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#mapDisplayToggle .toggle-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      state.mapDisplay = btn.dataset.val;
      applyFilters();
    });
  });

  // Busway toggle
  document.getElementById('buswayToggle').addEventListener('change', e => {
    state.excludeBusway = e.target.checked; applyFilters();
  });

  // Sort
  document.getElementById('sortSelect').addEventListener('change', e => {
    state.sort = e.target.value; applyFilters();
  });

  // Reset
  document.getElementById('resetBtn').addEventListener('click', resetFilters);

  // Mobile filter toggle
  document.getElementById('filterToggle').addEventListener('click', () => {
    const body = document.getElementById('sidebarBody');
    body.classList.toggle('open');
  });

  // Hash changes
  window.addEventListener('hashchange', checkHash);
}


/* ════════════════════════════════════════════════════════════════════
   MASTER MAP — single map view of all filtered routes
   ════════════════════════════════════════════════════════════════════ */

// Swavesey start point — where most routes begin from
const SWAVESEY = { lat: 52.3063, lon: -0.0004 };  // Swavesey Busway stop

// Compass direction → bearing (degrees clockwise from north)
const DIR_BEARING = {
  N: 0, NE: 45, E: 90, SE: 135, S: 180, SW: 225, W: 270, NW: 315
};

// Approximate lat/lon for a route based on direction and distance
// Uses actual start_lat/start_lon from sheet if available, otherwise
// estimates a point ~35% of total distance out from Swavesey in the
// named direction (representing the rough midpoint of the outward leg
// on a circular route).
function routeApproxCoords(route) {
  const lat = parseFloat(route.start_lat);
  const lon = parseFloat(route.start_lon);
  if (!isNaN(lat) && !isNaN(lon) && lat !== 0 && lon !== 0) {
    return { lat, lon, exact: true };
  }
  // Fallback: estimate from direction + distance
  const dir   = normaliseDir(route.direction);
  const bearing = DIR_BEARING[dir] ?? 180; // default south if unknown
  const dist  = safeNum(route.distance_miles) || 20;
  const reach = dist * 0.35; // miles to the approximate midpoint
  const bearingRad = bearing * Math.PI / 180;
  // Degrees per mile at this latitude
  const latPerMile = 1 / 69.0;
  const lonPerMile = 1 / (69.0 * Math.cos(SWAVESEY.lat * Math.PI / 180));
  return {
    lat: SWAVESEY.lat + reach * Math.cos(bearingRad) * latPerMile,
    lon: SWAVESEY.lon + reach * Math.sin(bearingRad) * lonPerMile,
    exact: false
  };
}

// Colour for circle marker — matches card badge colours
function markerColour(miles) {
  if (miles < 25)  return '#22a05a'; // green
  if (miles <= 40) return '#d97706'; // amber
  return '#dc2626';                  // red
}

let masterMapInstance = null;
let masterMarkerLayer = null;  // circle markers — top layer, receives clicks
let masterCafeLayer   = null;  // café markers — middle layer
let masterGpxLayer    = null;  // GPX track lines — bottom layer, interactive with popup + hover
let currentView = 'list';

function switchView(view) {
  currentView = view;
  document.getElementById('listPanel').style.display = view === 'list' ? '' : 'none';
  document.getElementById('masterMapPanel').classList.toggle('active', view === 'map');
  document.getElementById('tabList').classList.toggle('active', view === 'list');
  document.getElementById('tabMap').classList.toggle('active', view === 'map');
  if (view === 'map') refreshMasterMap();
}

function buildRoutePopupHtml(route, slug) {
  const dist      = safeNum(route.distance_miles);
  const dir       = normaliseDir(route.direction) || '\u2014';
  const timeStr   = safe(route.estimated_time) || '\u2014';
  const ascentStr = safeNum(route.ascent_metres) ? safeNum(route.ascent_metres) + ' m' : '\u2014';
  const coords    = routeApproxCoords(route);
  const exactNote = coords.exact ? '' : '<div style="font-size:0.7rem;color:#999;margin-top:0.3rem">\u26a0\ufe0f Approximate position</div>';

  return `
    <div class="map-route-popup">
      <div class="pop-name">${escHtml(safe(route.route_name))}</div>
      <div class="pop-stats">
        <span>\ud83d\udccf ${dist} mi</span>
        <span>\u26f0 ${ascentStr}</span>
        <span>\u23f1 ${timeStr}</span>
        <span>\ud83e\udded ${dir}</span>
      </div>
      ${safe(route.garmin_link) ? `<a href="${escHtml(safe(route.garmin_link))}" target="_blank" rel="noopener noreferrer" style="display:block;text-align:center;margin-bottom:0.4rem;font-size:0.75rem;color:#e8621a">Open in Garmin Connect \u2197</a>` : ''}
      <button class="pop-btn" onclick="window.scrollToCard('${slug}')">
        View full details \u2192
      </button>
      ${exactNote}
    </div>`;
}

async function refreshMasterMap() {
  if (currentView !== 'map') return; // don't bother if not visible

  const mapEl = document.getElementById('masterMap');

  // First time: defer map creation until after the container has painted
  if (!masterMapInstance) {
    // requestAnimationFrame ensures the browser has rendered the panel
    // before Leaflet tries to measure it — fixes blank tile issue on mobile
    await new Promise(resolve => requestAnimationFrame(() => setTimeout(resolve, 50)));
    masterMapInstance = L.map(mapEl)
                         .setView([SWAVESEY.lat, SWAVESEY.lon], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 18,
      crossOrigin: true
    }).addTo(masterMapInstance);
    // Home marker for Swavesey
    L.marker([SWAVESEY.lat, SWAVESEY.lon], {
      icon: L.divIcon({
        className: '',
        html: '<div style="width:14px;height:14px;background:#1a2e4a;border:3px solid white;border-radius:50%;box-shadow:0 1px 4px rgba(0,0,0,0.4)"></div>',
        iconSize: [14, 14], iconAnchor: [7, 7]
      })
    }).addTo(masterMapInstance).bindTooltip('🏠 Swavesey HQ', { permanent: false });
    masterMapInstance.invalidateSize();
  }

  // Always re-create layers in correct z-order: GPX (bottom), cafés (middle), route markers (top)
  if (masterGpxLayer)    { masterGpxLayer.clearLayers(); }
  else { masterGpxLayer  = L.layerGroup().addTo(masterMapInstance); }
  if (masterCafeLayer)   { masterCafeLayer.clearLayers(); }
  else { masterCafeLayer = L.layerGroup().addTo(masterMapInstance); }
  if (masterMarkerLayer) { masterMarkerLayer.clearLayers(); }
  else { masterMarkerLayer = L.layerGroup().addTo(masterMapInstance); }

  // Plot café markers when display mode includes cafés
  const showCafes = (state.mapDisplay === 'all' || state.mapDisplay === 'cafes');
  const showRoutes = (state.mapDisplay === 'all' || state.mapDisplay === 'routes');

  if (showCafes && allCafes.length > 0) {
    allCafes.forEach(cafe => {
      const lat = parseFloat(cafe.lat);
      const lon = parseFloat(cafe.lon);
      if (isNaN(lat) || isNaN(lon)) return;

      const cafeIcon = L.icon({
        iconUrl: 'images/cafe-icon.png', shadowUrl: '',
        iconSize: [36, 36], iconAnchor: [18, 36],
        popupAnchor: [0, -36], className: 'cafe-marker'
      });
      const name = escHtml(safe(cafe.cafe_name));
      L.marker([lat, lon], { icon: cafeIcon })
        .addTo(masterCafeLayer)
        .bindPopup(buildCafePopupHtml(cafe), { maxWidth: 220 })
        .bindTooltip(`🍳 ${name}`, { sticky: true });
    });
  }

  // In cafes-only mode, fit to café markers and skip routes
  if (!showRoutes) {
    if (allCafes.length > 0) {
      const cafeBounds = allCafes
        .filter(c => !isNaN(parseFloat(c.lat)) && !isNaN(parseFloat(c.lon)))
        .map(c => [parseFloat(c.lat), parseFloat(c.lon)]);
      if (cafeBounds.length > 0) masterMapInstance.fitBounds(cafeBounds, { padding: [40, 40], maxZoom: 12 });
    }
    masterMapInstance.invalidateSize(true);
    return;
  }

  if (filteredRoutes.length === 0) {
    // Zoom back to home if nothing to show
    masterMapInstance.setView([SWAVESEY.lat, SWAVESEY.lon], 10);
    return;
  }

  const bounds = [[SWAVESEY.lat, SWAVESEY.lon]];

  filteredRoutes.forEach((route, idx) => {
    const coords = routeApproxCoords(route);
    const dist   = safeNum(route.distance_miles);
    const colour = markerColour(dist);
    const slug   = slugify(safe(route.route_name));

    // Radius scales slightly with distance so big routes stand out
    const radius = 5 + Math.min(dist / 20, 5);

    const marker = L.circleMarker([coords.lat, coords.lon], {
      radius: Math.max(radius, 10),  // minimum 10px — easier to tap on mobile
      color: '#ffffff',
      fillColor: colour,
      fillOpacity: 0.9,
      weight: 2,
      opacity: 1,
      interactive: true,
    });

    marker.bindPopup(buildRoutePopupHtml(route, slug), { maxWidth: 240 });

    marker.bindTooltip(escHtml(safe(route.route_name)), { sticky: true });
    // Explicit click handler — more reliable than popup onclick across browsers
    marker.on('click', () => marker.openPopup());
    marker.addTo(masterMarkerLayer);
    bounds.push([coords.lat, coords.lon]);

    // If this route has a GPX file, draw the track on the master map
    // Rotate through a palette so overlapping tracks are distinguishable
    const GPX_PALETTE = [
      '#e8621a', // orange
      '#2563eb', // blue
      '#16a34a', // green
      '#9333ea', // purple
      '#dc2626', // red
      '#0891b2', // cyan
      '#d97706', // amber
      '#be185d', // pink
      '#059669', // emerald
      '#7c3aed', // violet
    ];
    // Dash patterns cycle independently of colours → 10 colours × 4 styles = 40 combos
    const GPX_DASHES = [
      null,          // solid
      '12 6',        // dashed
      '4 6',         // dotted
      '12 4 4 4',    // dash-dot
    ];
    const gpxColour = GPX_PALETTE[idx % GPX_PALETTE.length];
    const gpxDash   = GPX_DASHES[Math.floor(idx / GPX_PALETTE.length) % GPX_DASHES.length];

    if (safe(route.gpx_url)) {
      new L.GPX(safe(route.gpx_url), {
        async: true,
        polyline_options: {
          color: gpxColour,
          opacity: 0.7,
          weight: 4,
          dashArray: gpxDash,
        },
        marker_options: { startIconUrl: '', endIconUrl: '', shadowUrl: '', wptIconUrls: { '': '' } }
      }).on('loaded', function(e) {
        // Bind popup and hover effects to every polyline sublayer
        const popupHtml = buildRoutePopupHtml(route, slug);
        const routeLabel = escHtml(safe(route.route_name));
        e.target.eachLayer(function(layer) {
          if (layer.bindPopup) {
            layer.bindPopup(popupHtml, { maxWidth: 240 });
          }
          if (layer.bindTooltip) {
            layer.bindTooltip(routeLabel, { sticky: true });
          }
          if (layer.setStyle) {
            layer.on('mouseover', function() {
              this.setStyle({ weight: 7, opacity: 1.0, dashArray: gpxDash });
            });
            layer.on('mouseout', function() {
              this.setStyle({ weight: 4, opacity: 0.7, dashArray: gpxDash });
            });
          }
        });

        // Add to the BOTTOM layer so circle markers always sit on top and receive clicks first
        masterGpxLayer.addLayer(e.target);
        // Expand bounds to include the full track
        const gpxBounds = e.target.getBounds();
        if (gpxBounds.isValid()) masterMapInstance.fitBounds(gpxBounds.extend(bounds), { padding: [40,40], maxZoom: 12 });
      }).on('error', function() {
        // GPX load failed silently — marker still shows
      });
    }
  });

  // Fit map to show all markers with padding
  masterMapInstance.fitBounds(bounds, { padding: [40, 40], maxZoom: 12 });

  // Invalidate size in case the panel just became visible
  masterMapInstance.invalidateSize(true); // force tile reload after fitBounds
}

function scrollToCard(slug) {
  // Switch to list view first, then scroll after a beat
  switchView('list');
  setTimeout(() => {
    const el = document.getElementById('route-' + slug);
    if (!el) return;
    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    el.classList.add('highlighted');
    setTimeout(() => el.classList.remove('highlighted'), 3000);
  }, 120);
}

// Expose on window so Leaflet popup onclick strings can reach them
window.scrollToCard = scrollToCard;
window.switchView   = switchView;

async function init() {
  initControls();
  initFindMyRide();
  initCompare();
  // Show debug panel only if flag is set
  if (CONFIG.SHOW_DEBUG) {
    const dp = document.getElementById('debugPanel');
    if (dp) dp.style.display = '';
  }
  dbg('App initialising...');
  try {
    // Fetch routes, cafes and weather in parallel
    const [routes, cafes, weather] = await Promise.all([
      fetchRoutes(),
      fetchCafes(),
      fetchWeather().catch(e => { dbg(`Weather failed: ${e.message}`, false); return null; }),
    ]);
    allRoutes = routes;
    allCafes  = cafes;
    weatherData = weather;

    // Render weather strip + ride planner
    renderWeatherStrip(weatherData);
    renderRidePlanner(weatherData, allRoutes);

    dbg(`init complete — ${allRoutes.length} routes, ${allCafes.length} cafes loaded`, allRoutes.length > 0);
    applyFilters();
  } catch (err) {
    dbg(`init failed: ${err.message}`, false);
    console.error('Failed to load routes:', err);
    document.getElementById('routesGrid').innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">⚠️</div>
        <h3>Couldn't load routes</h3>
        <p>Check the debug panel above for details.</p>
      </div>`;
  }
}

init();
</script>
</body>
</html>
